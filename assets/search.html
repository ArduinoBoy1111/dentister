<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dentister</title>
    <link rel="stylesheet" href="style.css">
    
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <div id="loading_screen" class="loading_screen">
        <p style="font-size: 32px;">جارٍ التحميل</p>
        <div class="spinner"></div>
    </div>
    <main style="display: flex;width: 100%;height: 100vh;">
        
        <div class="main-content-area" style="align-items: center;display: flex;flex-direction: column;">
            <div class="search_area">
                
                <input id="search_2" type="text" oninput="refreshData()" placeholder="ادخل اسم المريض" name="search" class="search_bar"></input>
            </div>
            <div id="search_list" class="search_list"></div>
        </div>

        <div class="sidebar">
            <img src="logo.png" style="width: 70%;margin-top: 5%;" alt="">
            <ul>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('index')">جميع الحجوزات</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('implant')">الزراعة</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('braces')">التقويم</button></li>
                <li ><button style="font-size: 22px; text-align: center;width: 100%;" onclick="changeView('second')">الارسال و اللاستقبال</button></li>
                <li class="current_page"><button style=" font-size: 22px;text-align: center;width: 100%;"  onclick="changeView('search')">البحث</button></li>
                
            </ul>
            <div  class="doctor_select_area">
                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img id="selected_doctor_img" src="user-1.png" alt="">
                    </button>
                    <p id="selected_doctor_p" class="doctor_name">...</p>
                </div>
            </div>
            <div class="doctors_list" id="doctors_list" dir="rtl" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()">

                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user-1.png" alt="">
                    </button>
                    <p class="doctor_name">د.احمد</p>
                </div>

                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user-1.png" alt="">
                    </button>
                    <p class="doctor_name">د.مصطفى</p>
                </div>
                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user-1.png" alt="">
                    </button>
                    <p class="doctor_name">د.ضياء</p>
                </div>
            </div>

        </div>

        
        
    </main>
    
    <script>

        function changeView(view) {
            window.pywebview.api.navigate(view);
        }

        let patients = []
        
        let doctor = "0";
        let search_result = ""

        window.addEventListener('pywebviewready',async function() {
            onPatientsLoadStart();
            doctor = await window.pywebview.api.getCurrentDoctor();
            refreshDoctor();
            try {
                patients = await window.pywebview.api.get_patients();
                
            }
            finally {
                onPatientsLoadEnd();
            }
            refreshDoctor();
            refreshData();
        });

        function normalizeArabic(s) {
            if (!s) return "";
            const mapDigits = t => t.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]);
            return mapDigits(s)
                .toLowerCase()
                .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g,"") // remove diacritics
                .replace(/\u0640/g,"")  // tatweel
                .replace(/[\u200C-\u200F]/g,"") // zero-width marks
                .replace(/[إأٱآ]/g,"ا")
                .replace(/[ىةه]/g,"ه")  // << unify ى / ة / ه into ه
                .replace(/ؤ/g,"و")
                .replace(/ئ/g,"ي")
                .replace(/ء/g,"")
                .trim()
                .replace(/\s+/g," ");
        }


            function arabicIncludes(haystack, needle){
            const h = normalizeArabic(haystack);
            const n = normalizeArabic(needle);
            if(n=="") return true;
            if(!n) return false;
            return h.includes(n);
        } 
        
        function refreshData(){
            let results = [];
            let search_list = document.getElementById('search_list');
            search_result = document.getElementById('search_2').value.trim(); // <-- get input

            search_list.innerHTML = "";
            const filteredPatients = [];

            patients.forEach(patient => {
                if(arabicIncludes(patient.name, search_result)){
                    filteredPatients.push(patient);
                }
            });
            results = filteredPatients;
            
            
            results.forEach(result => {
                const patientDiv = document.createElement('div');
                patientDiv.dir = 'rtl';
                patientDiv.className = 'search_patient_card';

                patientDiv.addEventListener('click', (e) => {
                    // if click was inside the actions area, do nothing
                    if (e.target.closest('.call-button-search')) return;

                window.pywebview.api.set_current_patient(result.id, 0);
                window.pywebview.api.navigate('patient');
                });

                
                upper_div = document.createElement('div');
                upper_div.className = 'upper-div third-div';
                patientDiv.appendChild(upper_div);

                second_div = document.createElement('div');
                second_div.className = 'upper-div third-div';
                patientDiv.appendChild(second_div);

                lower_div = document.createElement('div');
                lower_div.className = 'upper-div third-div';
                patientDiv.appendChild(lower_div);

                const name = document.createElement('p');
                name.textContent = result.name;
                upper_div.appendChild(name);

                let doctor  = "";
                if (result.doctor.includes("0")) {
                    
                    doctor += " د.احمد و";
                }
                if (result.doctor.includes("1")) {
                    
                    doctor += " د.مصطفى و";
                }
                if (result.doctor.includes("2")) {
                    
                    doctor += " د.ضياء و";
                }
                let doctor_str = doctor.slice(0, -2);

                const doctor_p = document.createElement('p');
                doctor_p.textContent = `  الطبيب المشرف: ${doctor_str}`;
                doctor_p.style.fontSize = '16px';
                second_div.appendChild(doctor_p);

                const phone = document.createElement('p');
                phone.textContent = ` رقم الهاتف: ${result.phone_num}`;
                phone.style.fontSize = '16px';
                lower_div.appendChild(phone);

                const call_button = document.createElement('button');
                call_button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#ffffff" d="M160.2 25C152.3 6.1 131.7-3.9 112.1 1.4l-5.5 1.5c-64.6 17.6-119.8 80.2-103.7 156.4 37.1 175 174.8 312.7 349.8 349.8 76.3 16.2 138.8-39.1 156.4-103.7l1.5-5.5c5.4-19.7-4.7-40.3-23.5-48.1l-97.3-40.5c-16.5-6.9-35.6-2.1-47 11.8l-38.6 47.2C233.9 335.4 177.3 277 144.8 205.3L189 169.3c13.9-11.3 18.6-30.4 11.8-47L160.2 25z"/></svg>'
                call_button.className = 'call-button-search';
                call_button.onclick = () => {
                    const phoneNumber = result.phone_num;
                    window.pywebview.api.call_number(phoneNumber);
                };
                lower_div.appendChild(call_button);

                search_list.appendChild(patientDiv);

            });
            
            
        }
        function showDoctorsList(){
            const list = document.getElementById('doctors_list');
            list.style.width = "40vw";
            list.style.opacity = "1";
        }
        function hideDoctorsList(){
            const list = document.getElementById('doctors_list');
            list.style.width = "0%";
            list.style.opacity = "0";
        }

        function refreshDoctor(){
            
            const data = {
                "-1": { name: "الكل",     img: "user-1.png" },
                "0":    { name: "د.أحمد",   img: "user0.png" },
                "1":    { name: "د.مصطفى", img: "user1.png" },
                "2":    { name: "د.ضياء",   img: "user2.png" }
            };

            const d = data[doctor];
            const img = document.getElementById("selected_doctor_img");
            const p = document.getElementById("selected_doctor_p");
            const list = document.getElementById("doctors_list");

            if (!d) { p.textContent = doctor; return; }

            img.src = d.img;
            p.textContent = d.name;

            list.innerHTML = "";
            Object.keys(data).forEach(id => {
                if (Number(id) === Number(doctor)) return;
                const doctor_btn_group = document.createElement("div");
                doctor_btn_group.className = "doctor_btn_group";
                const btn = document.createElement("button");
                btn.className = "doctor_button";
                const i = document.createElement("img");
                i.src = data[id].img;
                const tp = document.createElement("p");
                tp.className = "doctor_name";
                tp.textContent = data[id].name;
                btn.appendChild(i);
                doctor_btn_group.appendChild(btn);
                doctor_btn_group.appendChild(tp);
                btn.onclick = () => selectDoctor(id);
                list.appendChild(doctor_btn_group);
            });
        }

        async function selectDoctor(id){
        await window.pywebview.api.changeCurrentDoctor(id);
        onPatientsLoadStart();
        try {
            patients = await window.pywebview.api.get_patients();
        }
        finally {
            doctor = String(id);
            onPatientsLoadEnd();
            refreshData();
            refreshDoctor();
            hideDoctorsList();
        }
        
    }
    function onPatientsLoadStart(){
        document.getElementById("loading_screen").style.display = "flex";

    }
    function onPatientsLoadEnd(){
        document.getElementById("loading_screen").style.display = "none";
    } 
    </script>
</body>
</html>
