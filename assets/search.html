<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dentister</title>
    <link rel="stylesheet" href="style.css">
    
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    
    <main style="display: flex;width: 100%;height: 100vh;">
        
        <div class="main-content-area" style="align-items: center;display: flex;flex-direction: column;">
            <div class="search_area">
                
                <input id="search_2" type="text" oninput="refreshData()" placeholder="ادخل اسم المريض" name="search" class="search_bar"></input>
            </div>
            <div id="search_list" class="search_list"></div>
        </div>

        <div class="sidebar">
            <img src="logo.png" style="width: 70%;margin-top: 5%;" alt="">
            <ul>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('index')">جميع الحجوزات</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('implant')">الزراعة</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('braces')">التقويم</button></li>
                <li ><button style="font-size: 22px; text-align: center;width: 100%;" onclick="changeView('second')">الارسال و اللاستقبال</button></li>
                <li class="current_page"><button style=" font-size: 22px;text-align: center;width: 100%;"  onclick="changeView('search')">البحث</button></li>
                
            </ul>

        </div>

        
        
    </main>
    
    <script>

        function changeView(view) {
            window.pywebview.api.navigate(view);
        }

        let patients = []

        let search_result = ""

        window.addEventListener('pywebviewready',async function() {
            patients = await window.pywebview.api.get_patients();
            refreshData();
        });

        function normalizeArabic(s) {
            if (!s) return "";
            const mapDigits = t => t.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]);
            return mapDigits(s)
                .toLowerCase()
                .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g,"") // remove diacritics
                .replace(/\u0640/g,"")  // tatweel
                .replace(/[\u200C-\u200F]/g,"") // zero-width marks
                .replace(/[إأٱآ]/g,"ا")
                .replace(/[ىةه]/g,"ه")  // << unify ى / ة / ه into ه
                .replace(/ؤ/g,"و")
                .replace(/ئ/g,"ي")
                .replace(/ء/g,"")
                .trim()
                .replace(/\s+/g," ");
        }


            function arabicIncludes(haystack, needle){
            const h = normalizeArabic(haystack);
            const n = normalizeArabic(needle);
            if(n=="") return true;
            if(!n) return false;
            return h.includes(n);
        } 
        
        function refreshData(){
            let results = [];
            let search_list = document.getElementById('search_list');
            search_result = document.getElementById('search_2').value.trim(); // <-- get input

            search_list.innerHTML = "";
            const filteredPatients = [];

            patients.forEach(patient => {
                if(arabicIncludes(patient.name, search_result)){
                    filteredPatients.push(patient);
                }
            });
            results = filteredPatients;
            
            
            results.forEach(result => {
                const patientDiv = document.createElement('div');
                patientDiv.dir = 'rtl';
                patientDiv.className = 'search_patient_card';

                patientDiv.addEventListener('click', (e) => {
                    // if click was inside the actions area, do nothing
                    if (e.target.closest('.patient-buttons-area')) return;

                window.pywebview.api.set_current_patient(result.id, 0);
                window.pywebview.api.navigate('patient');
                });

                
                upper_div = document.createElement('div');
                upper_div.className = 'upper-div';
                patientDiv.appendChild(upper_div);

                lower_div = document.createElement('div');
                lower_div.className = 'lower-div';
                //patientDiv.appendChild(lower_div);

                const name = document.createElement('p');
                name.textContent = result.name;
                upper_div.appendChild(name);

                const phone = document.createElement('p');
                phone.textContent = ` رقم الهاتف: ${result.phone_num}`;
                phone.style.fontSize = '16px';
                upper_div.appendChild(phone);

                search_list.appendChild(patientDiv);

            });
            
            
        }
        
    </script>
</body>
</html>
