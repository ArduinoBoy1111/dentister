<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dentister</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <div id="loading_screen" class="loading_screen">
        <p style="font-size: 32px;">جارٍ التحميل</p>
        <div class="spinner"></div>
    </div>
    <div id="water_mark" class="water_mark">
        <img src="logo.png" alt="Watermark" style="width: 100%; height: 100%;">
    </div>
    <main style="display: flex;width: 100%;height: 100vh;">
        <div class="today-list">
           <div class="card">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%; height: 90px;margin-bottom: 8px;">
                    <div class="flex-line"></div>
                    <h1 id="current_day_header">غير معروف</h1>
                    <div class="flex-line"></div>
                    
                </div>
                <div class="patients-list" id="patients_list_area">
                    
                </div>
           </div>
           <div class="add-button-area">
                <button class="add-button" onclick="showform('meeting-form')">+</button>
                <button class="delete-button" onclick="showWarning()"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg></button>

            </div>
           
        </div>
        <div class="main-content-area">
            <div  class="flash_card">
                <h1 id="context">اختر أحد الأيام المتاحة لإضافة الجلسة</h1>
                <button onclick="switchToNonAdding()" class="flash_button">✕</button>
            </div>
            <div id="month_bar" style="display: flex;width: 100%;justify-content: space-between;align-items: center;">
                <button style="width: 8%;height: 6%;" onclick="changeMonth(1)"><</button>
                <h1 id="current_month" style="font-size: 4vw;text-align: center;"></h1>
                <button style="width: 8%;height: 6%;" onclick="changeMonth(-1)">></button>
            </div>
            <div class="display" dir="ltr" style="display:flex;flex-wrap:wrap;width:100%;height:fit-content;justify-content: space-evenly;align-items: start;transition: all 0.4s ease-in-out !important;">

            </div>
        </div>
        <div class="sidebar">
            <img src="logo.png" style="width: 70%;margin-top: 5%;" alt="">
            <ul>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('index')">جميع الحجوزات</button></li>
                <li class="current_page" ><button  style=" text-align: center;width: 100%;"  onclick="changeView('implant')">الزراعة</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('braces')">التقويم</button></li>
                <li ><button style="font-size: 22px; text-align: center;width: 100%;" onclick="changeView('second')">الارسال و اللاستقبال</button></li>
                <li><button style=" font-size: 22px;text-align: center;width: 100%;"  onclick="changeView('search')">البحث</button></li>
                
            </ul>
            <div  class="doctor_select_area">
                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img id="selected_doctor_img" src="user-1.png" alt="">
                    </button>
                    <p id="selected_doctor_p" class="doctor_name">...</p>
                </div>
            </div>
            <div class="doctors_list" id="doctors_list" dir="rtl" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()">

                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user-1.png" alt="">
                    </button>
                    <p class="doctor_name">د.احمد</p>
                </div>

                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user-1.png" alt="">
                    </button>
                    <p class="doctor_name">د.مصطفى</p>
                </div>
                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user-1.png" alt="">
                    </button>
                    <p class="doctor_name">د.ضياء</p>
                </div>
            </div>

        </div>

        <form action="" hidden class="form" id="form">
            <div class="form-card">
                <div style="width: 100%;">
                    <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                        <div class="flex-line"></div>
                        <h1 >اضافة مريض</h1>
                        <div class="flex-line"></div>
                    </div>

                    <div class="form-group">
                        <label for="name">الاسم</label>
                        <input type="text" name="name" id="name" placeholder="ادخل الاسم" required>
                    </div>

                    <div class="form-group">
                        <label for="phone_num">الرقم</label>
                        <input type="number" name="phone_num" id="phone_num" placeholder="ادخل الرقم" required>
                    </div>
                    
                    <div class="form-group">
                        <label>الطبيب</label>
                        <div id="doctor_group" style="width:75%;display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
                            <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" class="doc-check" data-val="0"> د.احمد
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" class="doc-check" data-val="1"> د.مصطفى
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" class="doc-check" data-val="2"> د.ضياء
                            </label>
                        </div>
                        <!-- this is what will be submitted -->
                        <input type="hidden" name="doctor" id="doctor_value" value="">
                    </div>

                </div>



                <div class="buttons-area" style="justify-content: center; align-items: center;">
                    <button type="button" class="ok-button" onclick="submitform('create_patient')">موافق</button>
                    <button type="button" class="cancel-button" onclick="closeform('form',false)">إلغاء</button>
                </div>
            </div>
        </form>

        <form action="" hidden class="form" id="meeting-form">
            <div class="form-card">
                <div style="width: 100%;">
                    <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                        <div class="flex-line"></div>
                        <h1 >اضافة جلسة</h1>
                        <div class="flex-line"></div>
                    </div>

                    <div style="display: flex;width: 100%;justify-content: center;gap: 10%;margin-bottom: 3%;">
                        <button id="name_button" type="button" onclick="switchToName()"  class="option_button active"> استخدام الاسم</button>
                        <button id="number_button" type="button" onclick="switchToNumber()" class="option_button ">استخدام الرقم</button>
                    </div>

                    <!--##########################-->
                    <!-- The dynamic search area  -->
                    <!--##########################-->
                    <div class="form-group">
                        <label  for="search ">المريض</label>
                        <input  oninput="listPatients()" onfocus="listPatients()" id="search" name="search" type="text">
                        <div style="display: none;" id="current_patient" class="selected_patient">
                            <p id="current_patient_name"></p>
                            <p id="current_patient_number"></p>
                        </div>
                        <div class="suggestions_list" id="suggestions_list"></div>
                    </div>
                    
            

                    <div class="form-group">
                        <label  for="info">المعلومات</label>
                        <textarea name="info" id="info" placeholder="ادخل المعلومات" rows="2" ></textarea>
                    </div>
   
                    <div class="form-group" style="margin-top:4%;width: 50%;">
                        <label  for="ifo">الوقت</label>
                        
                        <div style="margin-left:4%;">
                            <button type="button" id="day_button" onclick="switchToDay()" class="time-button ">صباحاً</button>
                            <button type="button" id="night_button" onclick="switchToNight()" class="time-button active">مساءً</button>
                        </div>
                    </div>

                    <input type="date" name="date" id="date" hidden value="" required>
                </div>



                <div class="buttons-area" style="justify-content: center; align-items: center;">
                    <button type="button" class="ok-button" onclick="submitform('create_meeting')">موافق</button>
                    <button type="button" class="cancel-button" onclick="closeform('meeting-form',false)">إلغاء</button>
                </div>
            </div>
        </form>

        <div class="warning-card">
            <p style="font-size: 20px;text-align: center;">هل انت متأكد من القيام بحذف جميع المرضى لتاريخ <br><span style="margin-top: 3px;" id="warning-date"></span></p>
            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button class="ok-button" onclick="deleteMeetings()">نعم</button>
                <button class="cancel-button" onclick="hideWarning()">لا</button>
            </div>
        </div>


        <div id="success_card" class="success_card"> ! تمت إضافة الجلسة بنجاح </div>
        <div id="no_patient_card" class="no_patient_card">يرجى ادخال المريض اولاً </div>
        <div id="missing_data" class="missing_data"></div>
    </main>
    
    <script>

        let meetings = [];
        let patients = [];
        let search_mode = "name";
        let list_state = 0;
        let editing = false;
        let editing_patient = null;
        let adding_meeting = false;
        let time = 0;
        
        let doctor = "0";
        let selected_patient = null;
        today_header = document.getElementById('current_day_header');

        
        function changeView(view) {
            window.pywebview.api.navigate(view);
        }
        const now = new Date();

        const monthNames = [
          "كانون الثاني",  // January
          "شباط",        // February
          "آذار",        // March
          "نيسان",       // April
          "أيار",        // May
          "حزيران",      // June
          "تموز",        // July
          "آب",          // August
          "أيلول",       // September
          "تشرين الأول",  // October
          "تشرين الثاني",  // November
          "كانون الأول"   // December
        ];
        let month = now.getMonth() + 1;
        let year = now.getFullYear();
        let day = now.getDate();
        let edit_id = null;


        let options = { weekday: 'long' };
        const dayNameArabic = now.toLocaleDateString('ar-EG', options);
        today_header.innerHTML = "اليوم: " + day + "/" + monthNames[month - 1] + "/" + year + "<br>" + "(" + dayNameArabic + ")";
        document.getElementById('warning-date').textContent = day + "/" + monthNames[month - 1] + "/" + year;

        const daysInMonth = new Date(year, month, 0).getDate();
        document.getElementById('current_month').textContent = " (" + month + ") " + monthNames[now.getMonth()]  + " " + now.getFullYear();
        
        createCalendar();
        const day_squares = document.querySelectorAll('.day-square');
        

        function markTodayOnce() {
        // only when viewing the real current month/year
        if (year !== now.getFullYear() || month !== (now.getMonth() + 1)) return;

        // wait a tick so the calendar DOM exists
        requestAnimationFrame(() => {
            const tags = document.querySelectorAll('.addr-tag');
            const el = tags[day - 1]; // 0-based index
            if (el) el.classList.add('active');
        });
        }

        markTodayOnce();
        function createCalendar() {
            const daysInMonth = new Date(year, month, 0).getDate();
            document.querySelector('.display').innerHTML = ''; // Clear previous content
            document.getElementById('current_month').textContent = " (" + month + ") " + monthNames[month - 1] + " " + year;
            for (let i = 1; i <= daysInMonth; i++) {
               const daySquare = document.createElement('div');
               const addrtag = document.createElement('button');
               const patient_num = document.createElement('div');
               addrtag.className = 'addr-tag';
                
               addrtag.onclick = () => {
                    if (adding_meeting) {
                        day = i;
                        const monthPadded = String(month).padStart(2, '0');
                        const dayPadded = String(day).padStart(2, '0');
                        const now_date = new Date(`${year}-${monthPadded}-${dayPadded}`);

                        const date = document.getElementById('date');

                        date.value = now_date; //date is being set 

                        
                        //
                        //
                        
                    }
                    day = i;
                    const monthPadded = String(month).padStart(2, '0');
                    const dayPadded = String(day).padStart(2, '0');
                    
                    const now_date = new Date(`${year}-${monthPadded}-${dayPadded}`);
                    const dayNameArabic = now_date.toLocaleDateString('ar-EG', options);
                    today_header.innerHTML = "اليوم: " + day + "/" + monthNames[month - 1] + "/" + year + "<br>" + "(" + dayNameArabic + ")";
                    update_list(new Date(year, month - 1, day));
                    const allAddrTags = document.querySelectorAll('.addr-tag');
                    allAddrTags.forEach(square => {
                        square.classList.remove('active');
                    });
                    addrtag.classList.add('active');

               };
               addrtag.style.textDecoration = 'none';
               daySquare.className = 'day-square';
               daySquare.textContent = i;
               patient_num.className = 'patient-num';
               patient_num.textContent = '';
               addrtag.appendChild(daySquare);
               addrtag.appendChild(patient_num);
               document.querySelector('.main-content-area .display').appendChild(addrtag);
               
           }
           if(adding_meeting){
            switchToAdding();
           }
            
        }

        function changeMonth(direction) {
            month += direction;
            if (month < 1) {
                month = 12;
                year -= 1;
            } else if (month > 12) {
                month = 1;
                year += 1;
            }
            createCalendar();
            update_list(new Date(year, month - 1, day));
        }
        function showform(form_id,instant = false){
            form = document.getElementById(form_id);
            form.hidden = false;
            form.style.opacity = 1;
        }
        
        function closeform(form_id,success = true){
            const form = document.getElementById(form_id);
            form.reset();
            form.hidden  = true;
            unselect_patient();
            if(success){
                const card = document.getElementById("success_card");
                if(form_id=="meeting-form"){
                    card.innerText = " ! تمت إضافة الجلسة بنجاح ";
                }
                else{
                    card.innerText = " ! تمت إضافة المريض بنجاح ";
                }
                
            }
            
        
        }
        document.getElementById('form').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        function flashOnce(id,time=1) {
            // make it flex instantly
            const el = document.getElementById(id);
            el.style.display = "flex";
            el.style.opacity = "1";

            // force reflow to apply instant show
            void el.offsetWidth;

            // re-enable fade
            el.style.transition = "opacity 0.6s ease-in-out";

            // after 1s, start fade out
            setTimeout(() => {
                el.style.opacity = "0";

                // when fade ends, hide fully
                el.addEventListener("transitionend", function handler() {
                if (el.style.opacity === "0") {
                    el.style.display = "none";
                }
                el.removeEventListener("transitionend", handler);
                });
            }, time*1000);
        }

        async function submitform(type) {
            
            if (!editing){

                if (type=="create_patient") {

                    let name = document.getElementById("name").value.trim();
                    let phone_num= document.getElementById("phone_num").value.trim();
                    let current_doctor = document.getElementById("doctor_value").value.trim();
                    

                    if(name == "" || (name.split(" ").length - 1) < 2){
                        showError("يرجى ادخال الاسم الثلاثي");
                    }
                    else if(phone_num == ""){
                        showError("يرجى ادخال رقم الهاتف");
                    }
                    else if(phone_num.length != 11){
                        showError("يرجى ادخال رقم الهاتف بشكل صحيح");
                    }
                    else if(!phone_num.startsWith("07")){
                        showError("يرجى ادخال رقم الهاتف بشكل صحيح<br>07*********");
                    }
                    else if(current_doctor == ""){
                        showError("يرجى اختيار الطبيب المشرف");
                    }
                    else {
                        const form = document.getElementById('form');
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData);
                        const chosen_doctor = document.getElementById("doctor_value").value;
                        await window.pywebview.api.createPatient(data);

                        await refreshMeetings(new Date(year, month - 1, day)); // update list without reloading

                        const maxId = Math.max(...patients.map(p => p.id));

                        // get the patient object with that max id
                        const highestIdPatient = patients.reduce((a, b) => (a.id > b.id ? a : b), patients[0]);
                        switchToMeeting();
                        if(chosen_doctor.includes(doctor)){
                            select_patient(highestIdPatient);
                        }
                        else{
                            showError("لقد تم انشاء مريض لطبيب اخر , للعثور على المريض يرجى تغيير الطبيب الحالي",3.8)
                        }
                    
                    }
                    
                    
                }
                else if (type=="create_meeting"){

                    if(selected_patient==null){
                        flashOnce("no_patient_card");
                    }
                    else{
                        const dateInput = document.getElementById('date');
                        const monthPadded = String(month).padStart(2, '0');
                        const dayPadded = String(day).padStart(2, '0');
                        dateInput.value = `${year}-${monthPadded}-${dayPadded}`;

                        const form = document.getElementById('meeting-form');
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData)

                        window.pywebview.api.createMeeting(data,time,selected_patient.id,"implant").then(() => {
                            refreshMeetings(new Date(year, month - 1, day)); // update list without reloading
                            closeform('meeting-form');
                        });
                    }
                    
                }
            }
            else {
                const dateInput = document.getElementById('date');
                const monthPadded = String(month).padStart(2, '0');
                const dayPadded = String(day).padStart(2, '0');
                dateInput.value = `${year}-${monthPadded}-${dayPadded}`;
                
                const form = document.getElementById('meeting-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData)
                window.pywebview.api.editMeeting(edit_id, data,time,selected_patient.id).then(() => {
                    refreshMeetings(new Date(year, month - 1, day)); // update list without reloading
                    closeform('meeting-form');
                    
                });
            }
            
            
        }

        window.addEventListener('pywebviewready',async function() {
            onPatientsLoadStart();
            doctor = await window.pywebview.api.getCurrentDoctor();
            refreshDoctor();
            try {
                meetings = await window.pywebview.api.get_meetings("implant");
                patients = await window.pywebview.api.get_patients();
                
            }
            finally {
                onPatientsLoadEnd();
            }
            listPatients();
            
            update_list(new Date(year, month - 1, day));
        });

        async function refreshMeetings(date) {
            onPatientsLoadStart();
            try {
                meetings = await window.pywebview.api.get_meetings("implant");
                patients = await window.pywebview.api.get_patients();
                doctor = await window.pywebview.api.getCurrentDoctor();
            }
            finally {
                onPatientsLoadEnd();
            }
            listPatients();
            update_list(date || new Date(year, month - 1, day));
        }

        function update_list(date) {
            const patient_list_area = document.getElementById('patients_list_area');
            patient_list_area.innerHTML = ''; // Clear previous content
            
            const filteredMeetings = meetings.filter(meeting => {
                const meetingsDate = new Date(meeting.date);
                return meetingsDate.getFullYear() === date.getFullYear() && meetingsDate.getMonth() + 1 === date.getMonth() + 1 && meetingsDate.getDate() === date.getDate();
            });
            document.getElementById('warning-date').textContent = day + "/" + monthNames[month - 1] + "/" + year;
            filteredMeetings.forEach(meeting => {
                const meetingDiv = document.createElement('div');
                meetingDiv.dir = 'rtl';
                meetingDiv.className = 'meeting-card';
                
                meetingDiv.addEventListener('click', (e) => {
                // if click was inside the actions area, do nothing
                if (e.target.closest('.patient-buttons-area')) return;

                window.pywebview.api.set_current_patient(meeting.patient.id, 2);
                window.pywebview.api.navigate('patient');
                });

                upper_div = document.createElement('div');
                upper_div.className = 'upper-div';
                meetingDiv.appendChild(upper_div);

                lower_div = document.createElement('div');
                lower_div.className = 'lower-div';
                meetingDiv.appendChild(lower_div);

                const name = document.createElement('p');
                name.textContent = meeting.patient.name;
                upper_div.appendChild(name);

                const phone = document.createElement('p');
                phone.textContent = `${meeting.patient.phone_num}`;
                phone.style.fontSize = '16px';
                upper_div.appendChild(phone);

                const info = document.createElement('p');
                info.textContent = `${meeting.info}`;
                lower_div.appendChild(info);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';

                
                deleteButton.className = 'delete-button';
                deleteButton.onclick = () => {
                    window.pywebview.api.deleteMeeting(meeting.id).then(() => {
                        refreshMeetings(new Date(year, month - 1, day)); // update list without reloading
                    });
                };
                const editButton = document.createElement('button');
                editButton.innerHTML = '<svg viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M3.5362 5.29854C3.861 5.23721 4.19511 5.34035 4.42884 5.57407L6.90007 8.0453C7.21718 8.36241 7.73131 8.36241 8.04842 8.0453C8.36553 7.7282 8.36553 7.21406 8.04842 6.89695L5.57841 4.42694C5.34457 4.1931 5.24146 3.85877 5.30297 3.53383C5.36449 3.2089 5.58266 2.93539 5.8858 2.8032C8.06696 1.85206 10.7034 2.26698 12.4903 4.05384C13.9041 5.46765 14.4588 7.41411 14.1581 9.24419L21.0366 16.1227C22.3936 17.4796 22.3936 19.6797 21.0366 21.0367C19.6796 22.3936 17.4796 22.3936 16.1226 21.0367L9.24405 14.1581C7.41401 14.4588 5.46762 13.904 4.05384 12.4903C2.26556 10.702 1.85139 8.06276 2.80548 5.88058C2.93789 5.57772 3.2114 5.35986 3.5362 5.29854ZM4.30644 8.2801C4.30858 9.29283 4.69632 10.3043 5.46805 11.076C6.50688 12.1149 7.97927 12.4581 9.30695 12.1009C9.6523 12.008 10.021 12.1066 10.2739 12.3595L17.5368 19.6225C18.1127 20.1984 19.0465 20.1984 19.6224 19.6225C20.1983 19.0466 20.1983 18.1128 19.6224 17.5369L12.3595 10.274C12.1066 10.0211 12.008 9.65241 12.1009 9.30705C12.4582 7.97934 12.1149 6.50691 11.076 5.46805C10.3059 4.69791 9.29699 4.31018 8.28635 4.30645L9.46264 5.48274C10.5608 6.58089 10.5608 8.36136 9.46264 9.45952C8.36448 10.5577 6.58401 10.5577 5.48586 9.45952L4.30644 8.2801Z" fill="#ffffff"></path> </g></svg>';

                editButton.className = 'edit-button';

                editButton.onclick = () => {
                    document.getElementById('info').value = meeting.info;
                    if (meeting.time==1){
                        switchToDay();
                    }
                    else{
                        switchToNight();
                    }
                    edit_id = meeting.id;
                    editing = true;
                    showform('meeting-form');
                    select_patient(meeting.patient)
                };

                const call_button = document.createElement('button');
                call_button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#ffffff" d="M160.2 25C152.3 6.1 131.7-3.9 112.1 1.4l-5.5 1.5c-64.6 17.6-119.8 80.2-103.7 156.4 37.1 175 174.8 312.7 349.8 349.8 76.3 16.2 138.8-39.1 156.4-103.7l1.5-5.5c5.4-19.7-4.7-40.3-23.5-48.1l-97.3-40.5c-16.5-6.9-35.6-2.1-47 11.8l-38.6 47.2C233.9 335.4 177.3 277 144.8 205.3L189 169.3c13.9-11.3 18.6-30.4 11.8-47L160.2 25z"/></svg>'
                call_button.className = 'call-button';
                call_button.onclick = () => {
                    const phoneNumber = meeting.patient.phone_num;
                    window.pywebview.api.call_number(phoneNumber);
                };

                const add_meeting_button = document.createElement('button');
                add_meeting_button.innerHTML = '+';
                add_meeting_button.className = 'meeting-button';
                

                const buttons_area = document.createElement('div');
                buttons_area.className = 'patient-buttons-area';
                lower_div.appendChild(buttons_area);
                buttons_area.appendChild(deleteButton);
                buttons_area.appendChild(editButton);
                buttons_area.appendChild(call_button);
                //buttons_area.appendChild(add_meeting_button);

                time_circle = document.createElement("div");
                time_circle.className = "time_circle"
                if(meeting.time){
                    time_circle.innerText= "صباحاً";
                    time_circle.style.background = "#63ddff";
                    time_circle.style.color = "black";
                }
                else{
                    time_circle.innerText= "مساءً";
                    time_circle.style.background = "#205fc9";
                    time_circle.style.color = "white";
                }
                meetingDiv.appendChild(time_circle);
                patient_list_area.appendChild(meetingDiv);
            });
            if (patient_list_area.children.length === 0) {
                const noPatientsMessage = document.createElement('div');
                noPatientsMessage.style.marginTop = '30px';
                noPatientsMessage.innerText = 'لا يوجد مرضى لهذا اليوم.';
                patient_list_area.appendChild(noPatientsMessage);
            }
            const patients_nums = document.querySelectorAll('.addr-tag > .patient-num');
            patients_nums.forEach((num, index) => {
                const filteredMeetings = meetings.filter(meeting => {
                    const meetingDate = new Date(meeting.date);
                    return meetingDate.getFullYear() === date.getFullYear() && meetingDate.getMonth() + 1 === date.getMonth() + 1 && meetingDate.getDate() === index + 1;
                });
                num.textContent = `${filteredMeetings.length}`;
                if (filteredMeetings.length > 0) {
                    num.style.color = '#1a1a1a';
                    num.style.display = 'flex';
                } else {
                    num.style.display = 'none';
                }
                if (filteredMeetings.length >= 10) {
                    num.style.color = '#fcc203';
                }
                if (filteredMeetings.length >= 15) {
                    num.style.color = '#ff3d3d';
                }
            });
        }
        function deleteMeetings() {

                const monthPadded = String(month).padStart(2, '0');
                const dayPadded = String(day).padStart(2, '0');
                const date = `${year}-${monthPadded}-${dayPadded}`;

                window.pywebview.api.deleteMeetings(date).then(() => {
                    refreshMeetings(new Date(year, month - 1, day)); // update list without reloading
                });
                hideWarning()
            }
        function showWarning() {
            const warningCard = document.querySelector('.warning-card');
            warningCard.style.display = 'flex';
        }
        function hideWarning() {
            const warningCard = document.querySelector('.warning-card');
            warningCard.style.display = 'none';
        }
        
        function switchToAdding(){
            adding_meeting = true;
            document.querySelector('.flash_card').style.height = '12%';
            document.querySelector('.flash_card').style.opacity = '1';
            document.querySelectorAll('.addr-tag').forEach(el => {
                el.classList.add('wiggle');
            });

            document.querySelectorAll('.wiggle').forEach(el => {
                el.style.animationDelay = `${Math.random() * 0.5}s`;
            });
            document.querySelector('.today-list').style.width = "0%";
            document.getElementById('month_bar').style.marginTop = "10px ";
            document.getElementById('water_mark').style.opacity = "0.0";

        }
        
        function switchToNonAdding(){
            adding_meeting = false;
            document.querySelector('.flash_card').style.height = '0';
            document.querySelector('.flash_card').style.opacity = '0';
            document.querySelectorAll('.wiggle').forEach(el => {
                el.classList.remove('wiggle');
            });
            document.querySelector('.today-list').style.width = "45%";

            document.getElementById('month_bar').style.marginTop = "0px ";
            document.getElementById('water_mark').style.opacity = "0.12";
        }

        function switchToDay(){
            time = 1;
            document.getElementById("day_button").classList.add('active');
            document.getElementById("night_button").classList.remove('active');

            
        }
        function switchToNight(){
            time = 0;
            document.getElementById("day_button").classList.remove('active');
            document.getElementById("night_button").classList.add('active');

            
        }

        
        function switchToPatient(){
            unselect_patient();
            showform('form',instant=true);
            closeform('meeting-form',success=false);
        }
        function switchToMeeting(){
            showform('meeting-form',instant=true);
            closeform('form',success=false);
        }   

        function switchToName(){
            search_mode = "name";
            document.getElementById("search").value = '';
            document.getElementById("name_button").classList.add("active");
            document.getElementById("number_button").classList.remove("active");
            listPatients();
        }
        function switchToNumber(){
            search_mode = "num";
            document.getElementById("search").value = '';
            document.getElementById("name_button").classList.remove("active");
            document.getElementById("number_button").classList.add("active");
            listPatients();
        }
        function showList(){
            list_state = 1;
        }
        function hideist(){
            list_state = 0;
        }

        function select_patient(patient){
            selected_patient = patient;
            const row = document.getElementById("current_patient");
            row.style.display = "flex";
            row.onclick = unselect_patient;
            document.getElementById("current_patient_name").textContent = patient.name;
            document.getElementById("current_patient_number").textContent = patient.phone_num;
            document.getElementById("search").style.display = "none";
            document.getElementById("suggestions_list").innerHTML = "";
        }

        function unselect_patient(){
            selected_patient = null;
            const row = document.getElementById("current_patient");
            row.style.display = "none";
            row.onclick = null;
            document.getElementById("current_patient_name").textContent = "";
            document.getElementById("current_patient_number").textContent = "";
            const input = document.getElementById("search");
            input.style.display = "block";
            input.focus();
        }


        function normalizeArabic(s) {
            if (!s) return "";
            const mapDigits = t => t.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]);
            return mapDigits(s)
                .toLowerCase()
                .replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g,"") // remove diacritics
                .replace(/\u0640/g,"")  // tatweel
                .replace(/[\u200C-\u200F]/g,"") // zero-width marks
                .replace(/[إأٱآ]/g,"ا")
                .replace(/[ىةه]/g,"ه")  // << unify ى / ة / ه into ه
                .replace(/ؤ/g,"و")
                .replace(/ئ/g,"ي")
                .replace(/ء/g,"")
                .trim()
                .replace(/\s+/g," ");
        }


            function arabicIncludes(haystack, needle){
            const h = normalizeArabic(haystack);
            const n = normalizeArabic(needle);
            if(n=="") return true;
            if(!n) return false;
            return h.includes(n);
        }

        function listPatients() {
            const search_area = document.getElementById("suggestions_list");
            const search_result = document.getElementById("search").value;
            search_area.innerHTML = "";

            if (search_mode === "name") {
                for (let i = patients.length - 1; i >= 0; i--) {
                const patient = patients[i];
                if (arabicIncludes(patient.name, search_result)) {
                    const patientDiv = document.createElement("div");
                    patientDiv.className = "patient_div";
                    patientDiv.dataset.idx = i; // keep pointing to the original array index

                    const patient_name = document.createElement("p");
                    const patient_number = document.createElement("p");
                    patient_name.innerText = patient.name;
                    patient_number.innerText = patient.phone_num;

                    patientDiv.appendChild(patient_name);
                    patientDiv.appendChild(patient_number);
                    search_area.appendChild(patientDiv);
                }
                }

                if (search_area.childElementCount === 0) {
                const patientDiv = document.createElement("div");
                patientDiv.className = "patient_div custom";
                patientDiv.dataset.idx = -1;

                const patient_name = document.createElement("p");
                const button = document.createElement("button");
                button.type = "button";
                patient_name.innerText = "لم يتم العثور على مريض بهذا الاسم";
                button.innerText = "اضافة مريض جديد";
                button.className = "add-button patient-btn";

                patientDiv.onclick = () => switchToPatient();
                patientDiv.appendChild(patient_name);
                patientDiv.appendChild(button);
                search_area.appendChild(patientDiv);
                }

            } else if (search_mode === "num") {
                for (let i = patients.length - 1; i >= 0; i--) {
                const patient = patients[i];
                if ((patient.phone_num || "").trim().includes((search_result || "").trim())) {
                    const patientDiv = document.createElement("div");
                    patientDiv.className = "patient_div";
                    patientDiv.dataset.idx = i;

                    const patient_name = document.createElement("p");
                    const patient_number = document.createElement("p");
                    patient_name.innerText = patient.name;
                    patient_number.innerText = patient.phone_num;

                    patientDiv.appendChild(patient_name);
                    patientDiv.appendChild(patient_number);
                    search_area.appendChild(patientDiv);
                }
                }

                if (search_area.childElementCount === 0) {
                const patientDiv = document.createElement("div");
                patientDiv.className = "patient_div custom";
                patientDiv.dataset.idx = -1;

                const patient_name = document.createElement("p");
                const button = document.createElement("button");
                button.type = "button";
                patient_name.innerText = "لم يتم العثور على مريض بهذا الرقم";
                button.innerText = "اضافة مريض جديد";
                button.className = "add-button patient-btn";

                patientDiv.onclick = () => switchToPatient();
                patientDiv.appendChild(patient_name);
                patientDiv.appendChild(button);
                search_area.appendChild(patientDiv);
                }
            }
        }

        const suggestions = document.getElementById('suggestions_list');

        suggestions.addEventListener('mousedown', (e) => {
            const card = e.target.closest('.patient_div[data-idx]');
            if (!card) return;
            e.preventDefault();
            select_patient(patients[+card.dataset.idx]);
        });
        function updateDoctorValue() {
            const sel = Array.from(document.querySelectorAll('#doctor_group .doc-check:checked'))
                .map(cb => cb.dataset.val)
                .sort()                 // always in 0,1,2 order
                .join('');
            document.getElementById('doctor_value').value = sel;
        }

        // initialize listeners when the page is ready
        window.addEventListener('pywebviewready', function () {
            document.querySelectorAll('#doctor_group .doc-check')
                .forEach(cb => cb.addEventListener('change', updateDoctorValue));
            updateDoctorValue(); // set initial (empty) value
            refreshDoctor();
        });
        function showDoctorsList(){
            const list = document.getElementById('doctors_list');
            list.style.width = "40vw";
            list.style.opacity = "1";
        }
        function hideDoctorsList(){
            const list = document.getElementById('doctors_list');
            list.style.width = "0%";
            list.style.opacity = "0";
        }

        function refreshDoctor(){
            
            const data = {
                "-1": { name: "الكل",     img: "user-1.png" },
                "0":    { name: "د.أحمد",   img: "user0.png" },
                "1":    { name: "د.مصطفى", img: "user1.png" },
                "2":    { name: "د.ضياء",   img: "user2.png" }
            };

            const d = data[doctor];
            const img = document.getElementById("selected_doctor_img");
            const p = document.getElementById("selected_doctor_p");
            const list = document.getElementById("doctors_list");

            if (!d) { p.textContent = doctor; return; }

            img.src = d.img;
            p.textContent = d.name;

            list.innerHTML = "";
            Object.keys(data).forEach(id => {
                if (Number(id) === Number(doctor)) return;
                const doctor_btn_group = document.createElement("div");
                doctor_btn_group.className = "doctor_btn_group";
                const btn = document.createElement("button");
                btn.className = "doctor_button";
                const i = document.createElement("img");
                i.src = data[id].img;
                const tp = document.createElement("p");
                tp.className = "doctor_name";
                tp.textContent = data[id].name;
                btn.appendChild(i);
                doctor_btn_group.appendChild(btn);
                doctor_btn_group.appendChild(tp);
                btn.onclick = () => selectDoctor(id);
                list.appendChild(doctor_btn_group);
            });
        }

        async function selectDoctor(id){
        await window.pywebview.api.changeCurrentDoctor(id);
        doctor = String(id);
        await refreshMeetings(new Date(year, month - 1, day));
        refreshDoctor();
        hideDoctorsList();
    }
    function showError(msg,time=1.5){
        const card = document.getElementById("missing_data");
        card.innerHTML = msg;
        flashOnce("missing_data",time);
    }
    let loadingTimer = null;

    function onPatientsLoadStart() {
        // set a delayed trigger
        loadingTimer = setTimeout(() => {
            document.getElementById("loading_screen").style.display = "flex";
        }, 300); // threshold = 0.1s
    }

    function onPatientsLoadEnd() {
        // cancel if still waiting
        clearTimeout(loadingTimer);
        loadingTimer = null;
        // hide if it was shown
        document.getElementById("loading_screen").style.display = "none";
    } 
    </script>
</body>
</html>