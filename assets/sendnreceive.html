<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dentister</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main style="display: flex;width: 100%;">
        <div class="today-list">
           <div class="card">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%; height: 30px;margin-bottom: 8px;">
                    <div class="flex-line"></div>
                    <h1 id="current_day_header">غير معروف</h1>
                    <div class="flex-line"></div>
                </div>
                <div class="patients-list" id="patients_list_area">
                    
                </div>
           </div>
           <div class="add-button-area">
                <button class="add-button" onclick="showform()">+</button>
                <button class="delete-button" onclick="showWarning()"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg></button>
                <button id="send-button" class="send-button" onclick="switchToSend()">الارسال</button>
                <button id="receive-button" class="receive-button" onclick="switchToReceive()">الاستقبال</button>
            </div>
           
        </div>
        <div class="main-content-area">
            <div style="display: flex;width: 100%;justify-content: space-between;align-items: center;">
                <button style="width: 8%;height: 6%;" onclick="changeMonth(1)"><</button>
                <h1 id="current_month" style="font-size: 4vw;"></h1>
                <button style="width: 8%;height: 6%;" onclick="changeMonth(-1)">></button>
            </div>
            <div class="display" dir="ltr" style="display:flex;flex-wrap:wrap;width:100%;height:fit-content;justify-content: space-evenly;align-items: start;">

            </div>
        </div>
        <div class="sidebar">
            
            <ul>
                <li><button onclick="changeView('index')">الصفحة الرئيسية</button></li>
                <li><button onclick="changeView('second')">الارسال و اللاستقبال</button></li>
            </ul>

        </div>

        <form action="" hidden class="form" id="form">
            <div class="form-card">
                <div style="width: 100%;">
                    <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                        <div class="flex-line"></div>
                        <h1 >اضافة مريض</h1>
                        <div class="flex-line"></div>
                    </div>

                    <div class="form-group">
                        <label for="name">الاسم</label>
                        <input type="text" name="name" id="name" placeholder="ادخل الاسم" required>
                    </div>

                    <div class="form-group">
                        <label for="phone_num">الرقم</label>
                        <input type="text" name="phone_num" id="phone_num" placeholder="ادخل الرقم" required>
                    </div>

                    <div class="form-group">
                        <label  for="clinic_name">المعلومات</label>
                        <textarea name="clinic_name" id="clinic_name" placeholder="ادخل المعلومات" rows="4" ></textarea>
                    </div>

                    <input type="date" name="date" id="date" hidden value="" required>
                    <input type="number" name="transfer_type" id="transfer_type" hidden value="1" required>
                </div>



                <div class="buttons-area" style="justify-content: center; align-items: center;">
                    <button type="button" class="ok-button" onclick="submitForm_T()">موافق</button>
                    <button type="button" class="cancel-button" onclick="closeform()">إلغاء</button>
                </div>
            </div>
        </form>
        <div class="warning-card">
            <p style="font-size: 20px;">هل انت متأكد من القيام بحذف جميع المرضى لتاريخ <span id="warning-date"></span> ؟</p>
            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button class="ok-button" onclick="deletePatients()">نعم</button>
                <button class="cancel-button" onclick="hideWarning()">لا</button>
            </div>
        </div>
    </main>
    
    <script>

        let transfers = [];
        let editing = false;
        today_header = document.getElementById('current_day_header');
        let state = 'send'; 

        function switchToSend() {
            document.getElementById('send-button').classList.add('active');
            document.getElementById('receive-button').classList.remove('active');
            state = 'send';
            document.getElementById('transfer_type').value = 1;
        }

        function switchToReceive() {
            document.getElementById('receive-button').classList.add('active');
            document.getElementById('send-button').classList.remove('active');
            state = 'receive';
            document.getElementById('transfer_type').value = 0;
        }
        switchToSend();
        function changeView(view) {
            window.pywebview.api.navigate(view);
        }
        const now = new Date();

        const monthNames = [
          "كانون الثاني",  // January
          "شباط",        // February
          "آذار",        // March
          "نيسان",       // April
          "أيار",        // May
          "حزيران",      // June
          "تموز",        // July
          "آب",          // August
          "أيلول",       // September
          "تشرين الأول",  // October
          "تشرين الثاني",  // November
          "كانون الأول"   // December
        ];
        let month = now.getMonth() + 1;
        let year = now.getFullYear();
        let day = now.getDate();
        let edit_id = null;
        today_header.textContent = "اليوم: " + day + "/" + monthNames[month - 1] + "/" + year;
        document.getElementById('warning-date').textContent = day + "/" + monthNames[month - 1] + "/" + year;

        const daysInMonth = new Date(year, month, 0).getDate();
        document.getElementById('current_month').textContent = " (" + month + ") " + monthNames[now.getMonth()]  + " " + now.getFullYear();
        
        createCalendar();

        function createCalendar() {
            const daysInMonth = new Date(year, month, 0).getDate();
            document.querySelector('.display').innerHTML = ''; // Clear previous content
            document.getElementById('current_month').textContent = " (" + month + ") " + monthNames[month - 1] + " " + year;
            for (let i = 1; i <= daysInMonth; i++) {
               const daySquare = document.createElement('div');
               const addrtag = document.createElement('button');
               addrtag.onclick = () => {
                   day = i;
                   today_header.textContent = "اليوم: " + day + "/" + monthNames[month - 1] + "/" + year;
                   update_list(new Date(year, month - 1, day));
               };
               addrtag.style.textDecoration = 'none';
               daySquare.className = 'day-square';
               daySquare.textContent = i;
               addrtag.appendChild(daySquare);
               document.querySelector('.main-content-area .display').appendChild(addrtag);
           }
        }

        function changeMonth(direction) {
            month += direction;
            if (month < 1) {
                month = 12;
                year -= 1;
            } else if (month > 12) {
                month = 1;
                year += 1;
            }
            createCalendar();
        }
        function showform(){
            form = document.getElementById('form');
            form.hidden = false;
            form.style.opacity = 0;
            form.style.transition = '0.15s ease-in-out';
            requestAnimationFrame(() => {
             form.style.opacity = 1;
            });
        }
        
        function closeform(){
            const form = document.getElementById('form');
            form.style.opacity = 1;
            form.style.transition = 'opacity 0.15s ease-in-out';
            requestAnimationFrame(() => {
                form.style.opacity = 0;
            });

            form.addEventListener('transitionend', function handler() {
                form.hidden = true;
                form.removeEventListener('transitionend', handler);
            });
            editing = false; // Reset editing state
            edit_id = null; // Reset edit ID
        }
        document.getElementById('form').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        function submitForm_T() {
            
            if (!editing){
                const dateInput = document.getElementById('date');
                const monthPadded = String(month).padStart(2, '0');
                const dayPadded = String(day).padStart(2, '0');
                dateInput.value = `${year}-${monthPadded}-${dayPadded}`;
                
                const form = document.getElementById('form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData)
                window.pywebview.api.submitForm_T(data).then(() => {
                    // Clear form fields
                    form.reset();
                    closeform();
                    refreshTransfers(new Date(year, month - 1, day)); // update list without reloading
                });
            }
            else {
                const dateInput = document.getElementById('date');
                const monthPadded = String(month).padStart(2, '0');
                const dayPadded = String(day).padStart(2, '0');
                dateInput.value = `${year}-${monthPadded}-${dayPadded}`;
                
                const form = document.getElementById('form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData)
                window.pywebview.api.editPatient(edit_id, data).then(() => {
                    closeform();
                    refreshTransfers(new Date(year, month - 1, day)); // update list without reloading
                    
                });
            }
            
            
        }

        window.addEventListener('pywebviewready',async function() {
            patients = await window.pywebview.api.get_patients();
            update_list(new Date(year, month - 1, day));
        });

        async function refreshTransfers(date) {
            transfers = await window.pywebview.api.get_transfers(); // fetch latest data
            update_list(date); // update DOM
        }

        function update_list(date) {
            const patient_list_area = document.getElementById('patients_list_area');
            patient_list_area.innerHTML = ''; // Clear previous content
            const filteredPatients = patients.filter(patient => {
                const patientDate = new Date(patient.date);
                return patientDate.getFullYear() === date.getFullYear() && patientDate.getMonth() + 1 === date.getMonth() + 1 && patientDate.getDate() === date.getDate();
            });
            document.getElementById('warning-date').textContent = day + "/" + monthNames[month - 1] + "/" + year;
            filteredPatients.forEach(patient => {
                const patientDiv = document.createElement('div');
                patientDiv.dir = 'rtl';
                patientDiv.className = 'patient-card';
                
                upper_div = document.createElement('div');
                upper_div.className = 'upper-div';
                patientDiv.appendChild(upper_div);

                lower_div = document.createElement('div');
                lower_div.className = 'lower-div';
                patientDiv.appendChild(lower_div);

                const name = document.createElement('p');
                name.textContent = patient.name;
                upper_div.appendChild(name);

                const phone = document.createElement('p');
                phone.textContent = `${patient.phone_num}`;
                upper_div.appendChild(phone);

                const info = document.createElement('p');
                info.textContent = `${patient.info}`;
                lower_div.appendChild(info);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';

                
                deleteButton.className = 'delete-button';
                deleteButton.onclick = () => {
                    window.pywebview.api.deletePatient(patient.id).then(() => {
                        refreshTransfers(new Date(year, month - 1, day)); // update list without reloading
                    });
                };
                const editButton = document.createElement('button');
                editButton.innerHTML = '<svg viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M3.5362 5.29854C3.861 5.23721 4.19511 5.34035 4.42884 5.57407L6.90007 8.0453C7.21718 8.36241 7.73131 8.36241 8.04842 8.0453C8.36553 7.7282 8.36553 7.21406 8.04842 6.89695L5.57841 4.42694C5.34457 4.1931 5.24146 3.85877 5.30297 3.53383C5.36449 3.2089 5.58266 2.93539 5.8858 2.8032C8.06696 1.85206 10.7034 2.26698 12.4903 4.05384C13.9041 5.46765 14.4588 7.41411 14.1581 9.24419L21.0366 16.1227C22.3936 17.4796 22.3936 19.6797 21.0366 21.0367C19.6796 22.3936 17.4796 22.3936 16.1226 21.0367L9.24405 14.1581C7.41401 14.4588 5.46762 13.904 4.05384 12.4903C2.26556 10.702 1.85139 8.06276 2.80548 5.88058C2.93789 5.57772 3.2114 5.35986 3.5362 5.29854ZM4.30644 8.2801C4.30858 9.29283 4.69632 10.3043 5.46805 11.076C6.50688 12.1149 7.97927 12.4581 9.30695 12.1009C9.6523 12.008 10.021 12.1066 10.2739 12.3595L17.5368 19.6225C18.1127 20.1984 19.0465 20.1984 19.6224 19.6225C20.1983 19.0466 20.1983 18.1128 19.6224 17.5369L12.3595 10.274C12.1066 10.0211 12.008 9.65241 12.1009 9.30705C12.4582 7.97934 12.1149 6.50691 11.076 5.46805C10.3059 4.69791 9.29699 4.31018 8.28635 4.30645L9.46264 5.48274C10.5608 6.58089 10.5608 8.36136 9.46264 9.45952C8.36448 10.5577 6.58401 10.5577 5.48586 9.45952L4.30644 8.2801Z" fill="#ffffff"></path> </g></svg>';

                editButton.className = 'edit-button';

                editButton.onclick = () => {
                    document.getElementById('name').value = patient.name;
                    document.getElementById('phone_num').value = patient.phone_num;
                    document.getElementById('clinic_name').value = patient.clinic_name;
                    document.getElementById('date').value = patient.date;
                    edit_id = patient.id;
                    editing = true;
                    showform();
                };
                const buttons_area = document.createElement('div');
                buttons_area.className = 'patient-buttons-area';
                lower_div.appendChild(buttons_area);
                buttons_area.appendChild(deleteButton);
                buttons_area.appendChild(editButton);

                patient_list_area.appendChild(patientDiv);
            });

            
            
        }
        function deletePatients() {

                const monthPadded = String(month).padStart(2, '0');
                const dayPadded = String(day).padStart(2, '0');
                const date = `${year}-${monthPadded}-${dayPadded}`;

                window.pywebview.api.deletePatients(date).then(() => {
                    refreshTransfers(new Date(year, month - 1, day)); // update list without reloading
                });
                hideWarning()
            }
        function showWarning() {
            const warningCard = document.querySelector('.warning-card');
            warningCard.style.display = 'flex';
        }
        function hideWarning() {
            const warningCard = document.querySelector('.warning-card');
            warningCard.style.display = 'none';
        }
    </script>
</body>
</html>