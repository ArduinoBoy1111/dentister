<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dentister</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="patient.css">
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <main style="display: flex;width: 100%;height: 100vh;">

        <div class="patient-card-area">
            <div class="info_card"></div>
        </div>

        <div class="sidebar">
            <img src="logo.png" style="width: 70%;margin-top: 5%;" alt="">
            <ul>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('index')">جميع الحجوزات</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('implant')">الزراعة</button></li>
                <li ><button  style=" text-align: center;width: 100%;"  onclick="changeView('braces')">التقويم</button></li>
                <li ><button style="font-size: 22px; text-align: center;width: 100%;" onclick="changeView('second')">الارسال و اللاستقبال</button></li>
                <li><button style=" font-size: 22px;text-align: center;width: 100%;"  onclick="changeView('search')">البحث</button></li>
            </ul>
            <div  class="doctor_select_area">
                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img id="selected_doctor_img" src="user.png" alt="">
                    </button>
                    <p id="selected_doctor_p" class="doctor_name">الكل</p>
                </div>
            </div>
            <div class="doctors_list" id="doctors_list" dir="rtl" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()">

                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user.png" alt="">
                    </button>
                    <p class="doctor_name">د.احمد</p>
                </div>

                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user.png" alt="">
                    </button>
                    <p class="doctor_name">د.مصطفى</p>
                </div>
                <div class="doctor_btn_group" onmouseover="showDoctorsList()" onmouseout="hideDoctorsList()" style="width: 100%;height: 100%;display: flex;justify-content: center; align-items: center;flex-direction: column;">
                    <button class="doctor_button"  >
                        <img src="user.png" alt="">
                    </button>
                    <p class="doctor_name">د.ضياء</p>
                </div>
            </div>
        </div>

        <div id="success_card" class="success_card"> ! تمت إضافة الجلسة بنجاح </div>
        
        
        
        <div id="reset-warning" class="warning-card">
            <p id="reset-warning-message" style="font-size: 20px;"></p>
            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button class="ok-button" onclick="resetAmounts()">نعم</button>
                <button class="cancel-button" onclick="hideResetWarning()">لا</button>
            </div>
        </div>

        <div id="treatment-warning" class="warning-card">
            <p id="treatment-warning-message" style="font-size: 20px;">هل أنت متأكد أنك تريد حذف الحالة لهذا المريض ؟</p>
            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button class="ok-button" onclick="resetTreatment()">نعم</button>
                <button class="cancel-button" onclick="hideTreatmentWarning()">لا</button>
            </div>
        </div>

        <div id="delete-patient-form" class="warning-card">
            <p id="delete-patient-message" style="font-size: 20px;">هل أنت متأكد أنك تريد حذف هذا المريض ؟</p>
            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button class="ok-button" onclick="deletePatient()">نعم</button>
                <button class="cancel-button" onclick="hideDeleteWarning()">لا</button>
            </div>
        </div>
    </main>
    
    <form action="" hidden class="form" id="meeting-form">
        <div class="form-card">
            <div style="width: 100%;">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <div class="flex-line"></div>
                    <h1 id="form-name">تعديل الجلسة</h1>
                    <div class="flex-line"></div>
                </div>

                <div class="form-group">
                    <label  for="info">المعلومات</label>
                    <textarea name="info" id="info" placeholder="ادخل المعلومات" rows="2" ></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date">التاريخ</label>
                    <input type="date" name="date" id="date" placeholder="ادخل التاريخ" >
                </div>
                
                <div class="form-group" style="margin-top:4%;width: 50%;">
                    <label  for="info">الوقت</label>
                    
                    <div style="margin-left:4%;">
                        <button type="button" id="day_button" onclick="switchToDay()" class="time-button ">صباحاً</button>
                        <button type="button" id="night_button" onclick="switchToNight()" class="time-button active">مساءً</button>
                    </div>
                </div>

            </div>

            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button type="button" id="submit_button" class="ok-button">موافق</button>
                <button type="button" class="cancel-button" onclick="closeform('meeting-form',false)">إلغاء</button>
            </div>
        </div>
    </form>

    <form action="" hidden class="form" id="edit-patient-form">
        <div class="form-card">
            <div style="width: 100%;">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <div class="flex-line"></div>
                    <h1 >تعديل معلومات المريض</h1>
                    <div class="flex-line"></div>
                </div>

                <div class="form-group">
                    <label  for="name">الاسم</label>
                    <input type="text" name="name" id="name" placeholder="ادخل الاسم" >
                </div>
                <div class="form-group">
                    <label for="phone_num">رقم الهاتف</label>
                    <input type="text" name="phone_num" id="phone_num" placeholder="ادخل رقم الهاتف" >
                </div>


                <div id="implant_total_group" class="form-group">
                    <label for="implant_total">مبلغ الزراعة</label>
                    <input  type="number" name="implant_total" id="implant_total" placeholder="ادخل المبلغ الكلي" >
                </div>

                <div id="implant_current_group" class="form-group">
                    <label for="implant_current">مبلغ المدخل</label>
                    <input type="number" name="implant_current" id="implant_current" placeholder="ادخل المبلغ المدخل" >
                </div>

                <div id="treat_type_group" class="form-group">
                    <label  for="treat_type">نوع الحالة</label>
                    <select name="treat_type" id="treat_type">
                        <option value="تغليف">تغليف</option>
                        <option value="ابتسامة">ابتسامة</option>
                        <option value="زراعة">زراعة</option>
                        <option value="متحرك">متحرك</option>
                        <option value="اخرى">اخرى</option>
                    </select>
                </div>

            </div>

            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button type="button" onclick="submitEditPatientForm()" class="ok-button">موافق</button>
                <button type="button" class="cancel-button" onclick="closeform('edit-patient-form',false)">إلغاء</button>
            </div>
        </div>
    </form>

    <form action="" hidden class="form" id="set-implant-price-form">
        <div class="form-card">
            <div style="width: 100%;">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <div class="flex-line"></div>
                    <h1 >تحديد سعر الزراعة</h1>
                    <div class="flex-line"></div>
                </div>


                <div class="form-group">
                    <label for="implant_total">المبلغ</label>
                    <input type="number" name="implant_total" id="implant_total_2" placeholder="ادخل المبلغ" >
                </div>

            </div>

            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button type="button"  class="ok-button" onclick="submitSetImplantPriceForm()">موافق</button>
                <button type="button" class="cancel-button" onclick="closeform('set-implant-price-form',false)">إلغاء</button>
            </div>
        </div>
    </form>

    <form action="" hidden class="form" id="set-treatment-type-form">
        <div class="form-card">
            <div style="width: 100%;">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <div class="flex-line"></div>
                    <h1 >تحديد نوع الحالة</h1>
                    <div class="flex-line"></div>
                </div>


                <div class="form-group">
                    <label  for="treat_type">نوع الحالة</label>
                    <select name="treat_type" id="treat_type">
                        <option value="تغليف">تغليف</option>
                        <option value="ابتسامة">ابتسامة</option>
                        <option value="زراعة">زراعة</option>
                        <option value="متحرك">متحرك</option>
                        <option value="اخرى">اخرى</option>
                    </select>
                </div>

            </div>

            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button type="button"  class="ok-button" onclick="submitSetTreatmentTypeForm()">موافق</button>
                <button type="button" class="cancel-button" onclick="closeform('set-treatment-type-form',false)">إلغاء</button>
            </div>
        </div>
    </form>
    
    <form action="" hidden class="form" id="add-implant-amount-form">
        <div class="form-card">
            <div style="width: 100%;">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <div class="flex-line"></div>
                    <h1 >اضافة مبلغ</h1>
                    <div class="flex-line"></div>
                </div>


                <div class="form-group">
                    <label for="amount">المبلغ</label>
                    <input type="number" name="amount" id="amount" placeholder="ادخل المبلغ" >
                </div>

            </div>

            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button type="button"  class="ok-button" onclick="addAmount()">موافق</button>
                <button type="button" class="cancel-button" onclick="closeform('add-implant-amount-form',false)">إلغاء</button>
            </div>
        </div>
    </form>

    <form action="" hidden class="form" id="transfer-form">
        <div class="form-card">
            <div style="width: 100%;">
                <div style="display: flex;align-items: center;justify-content: center;width: 100%;">
                    <div class="flex-line"></div>
                    <h1 >اضافة ارسال/استقبال</h1>
                    <div class="flex-line"></div>
                </div>
    
                <div class="form-group">
                    <label  for="transfer_type">نوع الحالة</label>
                    <select name="transfer_type" id="transfer_type">
                        <option id="send" value="1">ارسال</option>
                        <option id="receive" value="0">استقبال</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="clinic_name">المختبر</label>
                    <input type="text" name="clinic_name" id="clinic_name" placeholder="ادخل اسم المختبر" >
                </div>

                <div class="form-group">
                    <label for="date">التاريخ</label>
                    <input type="date" name="date" id="t_date" placeholder="ادخل التاريخ" >
                </div>
            </div>



            <div class="buttons-area" style="justify-content: center; align-items: center;">
                <button type="button" class="ok-button" onclick="submitTransferForm()">موافق</button>
                <button type="button" class="cancel-button" onclick="closeform('transfer-form', false)">إلغاء</button> <!-- success=false -->
            </div>
        </div>
    </form>
    <div id="missing_data" class="missing_data"></div>

    <script>
        let patient = null;
        let page_to_load = -1;
        let time = null;
        let editing = false;
        let edit_id = null;
        
        let doctor = "0";
        let meeting_type = "general";

        document.getElementById('submit_button').onclick = async () => {
            await submitform(meeting_type);
        };

        function changeView(view) {
            window.pywebview.api.navigate(view);
        }

        function renderTabs(activeIdx = 0) {
            const tabsArea = document.querySelector('.tabs_area');
            tabsArea.innerHTML = "";
            const tabNames = [
                "الحجوزات",
                "الارسال و اللاستقبال",
                "الزراعة",
                "التقويم"
            ];
            tabNames.forEach((name, idx) => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (idx === activeIdx ? ' active-tab' : '');
                tab.textContent = name;
                tab.onclick = () => {
                    renderTabs(idx);
                    if (idx === 0) showMeetings();
                    else if (idx === 1) showSendnReceive();
                    else if (idx === 2) showImplant();
                    else if (idx === 3) showBraces();
                };
                tabsArea.appendChild(tab);
            });
        }

        function showMeetings(){
            page_to_load = 0;
            renderTabs(0);
            const tabInfoArea = document.querySelector('.tab_info_area');
            tabInfoArea.innerHTML = "";
            patient.meetings.forEach(meeting => {
                if(meeting.meeting_type == "general"){
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => {
                        window.pywebview.api.deleteMeeting(meeting.id).then(() => {
                            refresh_data();
                        });
                    };
                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<svg viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M3.5362 5.29854C3.861 5.23721 4.19511 5.34035 4.42884 5.57407L6.90007 8.0453C7.21718 8.36241 7.73131 8.36241 8.04842 8.0453C8.36553 7.7282 8.36553 7.21406 8.04842 6.89695L5.57841 4.42694C5.34457 4.1931 5.24146 3.85877 5.30297 3.53383C5.36449 3.2089 5.58266 2.93539 5.8858 2.8032C8.06696 1.85206 10.7034 2.26698 12.4903 4.05384C13.9041 5.46765 14.4588 7.41411 14.1581 9.24419L21.0366 16.1227C22.3936 17.4796 22.3936 19.6797 21.0366 21.0367C19.6796 22.3936 17.4796 22.3936 16.1226 21.0367L9.24405 14.1581C7.41401 14.4588 5.46762 13.904 4.05384 12.4903C2.26556 10.702 1.85139 8.06276 2.80548 5.88058C2.93789 5.57772 3.2114 5.35986 3.5362 5.29854ZM4.30644 8.2801C4.30858 9.29283 4.69632 10.3043 5.46805 11.076C6.50688 12.1149 7.97927 12.4581 9.30695 12.1009C9.6523 12.008 10.021 12.1066 10.2739 12.3595L17.5368 19.6225C18.1127 20.1984 19.0465 20.1984 19.6224 19.6225C20.1983 19.0466 20.1983 18.1128 19.6224 17.5369L12.3595 10.274C12.1066 10.0211 12.008 9.65241 12.1009 9.30705C12.4582 7.97934 12.1149 6.50691 11.076 5.46805C10.3059 4.69791 9.29699 4.31018 8.28635 4.30645L9.46264 5.48274C10.5608 6.58089 10.5608 8.36136 9.46264 9.45952C8.36448 10.5577 6.58401 10.5577 5.48586 9.45952L4.30644 8.2801Z" fill="#ffffff"></path> </g></svg>';
                    editButton.className = 'edit-button';
                    editButton.onclick = () => {
                        document.getElementById('info').value = meeting.info;
                        document.getElementById('date').value = meeting.date;
                        if (meeting.time==1){
                            switchToDay();
                        }
                        else{
                            switchToNight();
                        }
                        edit_id = meeting.id;
                        editing = true;
                        document.getElementById('form-name').innerText = "تعديل الجلسة";
                        showform('meeting-form');
                    };
                    let time_word = meeting.time == 1 ? "صباحاً" : "مساءً";
                    const meetingDiv = document.createElement('div');
                    meetingDiv.classList.add('meeting');
                    meetingDiv.innerHTML = `
                        <div class="meeting_info_area">
                            <p>${meeting.info}</p>
                            <p>${time_word}</p>
                            <p style="font-size: 0.85em;">${meeting.date.replace(/-/g, '/')}</p>
                        </div>
                        <div class="btns_area"></div>
                    `;
                    meetingDiv.querySelector('.btns_area').appendChild(editButton);
                    meetingDiv.querySelector('.btns_area').appendChild(deleteButton);
                    tabInfoArea.appendChild(meetingDiv);
                }
            });
            const control_area = document.getElementById('control_area');
            control_area.innerHTML = "";
            control_area.style.height = "12%";
            meeting_type = "general";
            const addMeetingBtn = document.createElement('button');
            addMeetingBtn.className = 'add-button';
            addMeetingBtn.textContent = '+';
            addMeetingBtn.style.margin = '24px auto 0 auto';
            addMeetingBtn.style.display = 'block';
            addMeetingBtn.onclick = () => {
                document.getElementById('form-name').innerText = "اضافة جلسة";
                document.getElementById('meeting-form').reset();
                document.getElementById('info').value = '';
                document.getElementById('date').value = '';
                switchToNight();
                editing = false;
                edit_id = null;
                showform('meeting-form');
            };
            tabInfoArea.appendChild(addMeetingBtn);
        }

        function showSendnReceive(){
            page_to_load = 1;
            renderTabs(1);
            const tabInfoArea = document.querySelector('.tab_info_area');
            tabInfoArea.innerHTML = "";
            patient.transfers.forEach(transfer => {
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';
                deleteButton.className = 'delete-button';
                deleteButton.onclick = () => {
                    window.pywebview.api.deleteTransfer(transfer.id).then(() => {
                        refresh_data();
                    });
                };
                const editButton = document.createElement('button');
                editButton.innerHTML = '<svg viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M3.5362 5.29854C3.861 5.23721 4.19511 5.34035 4.42884 5.57407L6.90007 8.0453C7.21718 8.36241 7.73131 8.36241 8.04842 8.0453C8.36553 7.7282 8.36553 7.21406 8.04842 6.89695L5.57841 4.42694C5.34457 4.1931 5.24146 3.85877 5.30297 3.53383C5.36449 3.2089 5.58266 2.93539 5.8858 2.8032C8.06696 1.85206 10.7034 2.26698 12.4903 4.05384C13.9041 5.46765 14.4588 7.41411 14.1581 9.24419L21.0366 16.1227C22.3936 17.4796 22.3936 19.6797 21.0366 21.0367C19.6796 22.3936 17.4796 22.3936 16.1226 21.0367L9.24405 14.1581C7.41401 14.4588 5.46762 13.904 4.05384 12.4903C2.26556 10.702 1.85139 8.06276 2.80548 5.88058C2.93789 5.57772 3.2114 5.35986 3.5362 5.29854ZM4.30644 8.2801C4.30858 9.29283 4.69632 10.3043 5.46805 11.076C6.50688 12.1149 7.97927 12.4581 9.30695 12.1009C9.6523 12.008 10.021 12.1066 10.2739 12.3595L17.5368 19.6225C18.1127 20.1984 19.0465 20.1984 19.6224 19.6225C20.1983 19.0466 20.1983 18.1128 19.6224 17.5369L12.3595 10.274C12.1066 10.0211 12.008 9.65241 12.1009 9.30705C12.4582 7.97934 12.1149 6.50691 11.076 5.46805C10.3059 4.69791 9.29699 4.31018 8.28635 4.30645L9.46264 5.48274C10.5608 6.58089 10.5608 8.36136 9.46264 9.45952C8.36448 10.5577 6.58401 10.5577 5.48586 9.45952L4.30644 8.2801Z" fill="#ffffff"></path> </g></svg>';
                editButton.className = 'edit-button';
                editButton.onclick = () => {
                    if (transfer.transfer_type == 1){
                        document.getElementById('transfer_type').value = '1';
                    }
                    else{
                        document.getElementById('transfer_type').value = '0';
                    }
                    document.getElementById('clinic_name').value = transfer.clinic_name;
                    document.getElementById('t_date').value = transfer.date;
                    edit_id = transfer.id;
                    editing = true;
                    showform('transfer-form');
                };

                let type_word = transfer.transfer_type == 1 ? "ارسال" : "استقبال";
                const meetingDiv = document.createElement('div');   
                meetingDiv.classList.add('meeting');
                meetingDiv.innerHTML = `
                    <div class="meeting_info_area">
                        <p>${transfer.clinic_name}</p>
                        <p>${type_word}</p>
                        <p style="font-size: 0.85em;">${transfer.date.replace(/-/g, '/')}</p>
                    </div>
                    <div class="btns_area"></div>
                `;
                meetingDiv.querySelector('.btns_area').appendChild(editButton);
                meetingDiv.querySelector('.btns_area').appendChild(deleteButton);
                tabInfoArea.appendChild(meetingDiv);
            });
            const addMeetingBtn = document.createElement('button');
            addMeetingBtn.className = 'add-button';
            addMeetingBtn.textContent = '+';
            addMeetingBtn.style.margin = '24px auto 0 auto';
            addMeetingBtn.style.display = 'block';
            addMeetingBtn.onclick = () => {
                document.getElementById('transfer-form').reset();
                document.getElementById('transfer_type').value = '';
                document.getElementById('clinic_name').value = '';
                document.getElementById('t_date').value = '';
                editing = false;
                edit_id = null;
                showform('transfer-form');
            };
            tabInfoArea.appendChild(addMeetingBtn);
            const control_area = document.getElementById('control_area');
            control_area.innerHTML = "";
            control_area.style.height = "12%";
            if(patient.treat_type == "none"){
                
                control_area.style.justifyContent = "center";
                notify_p = document.createElement('p');
                notify_p.textContent = "لا توجد حالة محددة لهذا المريض , هل تريد تحديد حالة ؟";
                ok_button = document.createElement('button');
                ok_button.textContent = "نعم";
                ok_button.className = "ok-button";
                notify_p.className = "notify_p";
                ok_button.onclick = () => {
                    showform('set-treatment-type-form');
                };
                control_area.appendChild(notify_p);
                control_area.appendChild(ok_button);

            }
            else{
                if(!patient.implant_state){
                    control_area.style.justifyContent = "space-between";
                    const right_div = document.createElement('div');
                    right_div.className = 'right_control_div_custom';

                    const treat_type = document.createElement('div');
                    treat_type.className = 'total-amount';
                    treat_type.innerText = ` نوع الحالة : ${patient.treat_type}`;
                    right_div.appendChild(treat_type);


                    control_area.appendChild(right_div);

                    const left_div = document.createElement('div');
                    left_div.className = 'left_control_div';

                    const done_button = document.createElement('button');
                    done_button.textContent = "اتمام";
                    done_button.className = "done-button";
                    done_button.onclick = () => {
                        doneifyPatient();
                    };
                    left_div.appendChild(done_button);

                    control_area.appendChild(left_div);

                }
                else{
                    control_area.style.justifyContent = "space-between";
                    const right_div = document.createElement('div');
                    right_div.className = 'right_control_div_custom';

                    const treat_type = document.createElement('div');
                    treat_type.className = 'total-amount';
                    treat_type.innerText = ` نوع الحالة : ${patient.treat_type}`;
                    right_div.appendChild(treat_type);


                    control_area.appendChild(right_div);

                    const left_div = document.createElement('div');
                    left_div.className = 'left_control_div';

                    const done_div = document.createElement('div');
                    done_div.className = "done-div";
                    done_div.textContent = "مكتمل";
                    left_div.appendChild(done_div);

                    const reset = document.createElement('button');
                    reset.textContent = "حذف الحالة";
                    reset.className = "reset-button";
                    reset.onclick = () => {
                        showTreatmentWarning();
                    };
                    left_div.appendChild(reset);

                    control_area.appendChild(left_div);
                }
            }
        }

        function showImplant(){
            page_to_load = 2;
            renderTabs(2);
            const tabInfoArea = document.querySelector('.tab_info_area');
            tabInfoArea.innerHTML = "";
            patient.meetings.forEach(meeting => {
                if(meeting.meeting_type == "implant"){
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => {
                        window.pywebview.api.deleteMeeting(meeting.id).then(() => {
                            refresh_data();
                        });
                    };
                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<svg viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M3.5362 5.29854C3.861 5.23721 4.19511 5.34035 4.42884 5.57407L6.90007 8.0453C7.21718 8.36241 7.73131 8.36241 8.04842 8.0453C8.36553 7.7282 8.36553 7.21406 8.04842 6.89695L5.57841 4.42694C5.34457 4.1931 5.24146 3.85877 5.30297 3.53383C5.36449 3.2089 5.58266 2.93539 5.8858 2.8032C8.06696 1.85206 10.7034 2.26698 12.4903 4.05384C13.9041 5.46765 14.4588 7.41411 14.1581 9.24419L21.0366 16.1227C22.3936 17.4796 22.3936 19.6797 21.0366 21.0367C19.6796 22.3936 17.4796 22.3936 16.1226 21.0367L9.24405 14.1581C7.41401 14.4588 5.46762 13.904 4.05384 12.4903C2.26556 10.702 1.85139 8.06276 2.80548 5.88058C2.93789 5.57772 3.2114 5.35986 3.5362 5.29854ZM4.30644 8.2801C4.30858 9.29283 4.69632 10.3043 5.46805 11.076C6.50688 12.1149 7.97927 12.4581 9.30695 12.1009C9.6523 12.008 10.021 12.1066 10.2739 12.3595L17.5368 19.6225C18.1127 20.1984 19.0465 20.1984 19.6224 19.6225C20.1983 19.0466 20.1983 18.1128 19.6224 17.5369L12.3595 10.274C12.1066 10.0211 12.008 9.65241 12.1009 9.30705C12.4582 7.97934 12.1149 6.50691 11.076 5.46805C10.3059 4.69791 9.29699 4.31018 8.28635 4.30645L9.46264 5.48274C10.5608 6.58089 10.5608 8.36136 9.46264 9.45952C8.36448 10.5577 6.58401 10.5577 5.48586 9.45952L4.30644 8.2801Z" fill="#ffffff"></path> </g></svg>';
                    editButton.className = 'edit-button';
                    editButton.onclick = () => {
                        document.getElementById('info').value = meeting.info;
                        document.getElementById('date').value = meeting.date;
                        if (meeting.time==1){
                            switchToDay();
                        }
                        else{
                            switchToNight();
                        }
                        edit_id = meeting.id;
                        editing = true;
                        document.getElementById('form-name').innerText = "تعديل الجلسة";
                        showform('meeting-form');
                    };
                    let time_word = meeting.time == 1 ? "صباحاً" : "مساءً";
                    const meetingDiv = document.createElement('div');
                    meetingDiv.classList.add('meeting');
                    meetingDiv.innerHTML = `
                        <div class="meeting_info_area">
                            <p>${meeting.info}</p>
                            <p>${time_word}</p>
                            <p style="font-size: 0.85em;">${meeting.date.replace(/-/g, '/')}</p>
                        </div>
                        <div class="btns_area"></div>
                    `;
                    meetingDiv.querySelector('.btns_area').appendChild(editButton);
                    meetingDiv.querySelector('.btns_area').appendChild(deleteButton);
                    tabInfoArea.appendChild(meetingDiv);
                }
            });
            meeting_type = "implant";
            const addMeetingBtn = document.createElement('button');
            addMeetingBtn.className = 'add-button';
            addMeetingBtn.textContent = '+';
            addMeetingBtn.style.margin = '24px auto 0 auto';
            addMeetingBtn.style.display = 'block';
            addMeetingBtn.onclick = () => {
                document.getElementById('form-name').innerText = "اضافة جلسة";
                document.getElementById('meeting-form').reset();
                document.getElementById('info').value = '';
                document.getElementById('date').value = '';
                switchToNight();
                editing = false;
                edit_id = null;
                showform('meeting-form');
            };
            tabInfoArea.appendChild(addMeetingBtn);
            const control_area = document.getElementById('control_area');
            control_area.innerHTML = "";
            control_area.style.height = "12%";
            if(patient.implant_total == 0 ){
                
                control_area.style.justifyContent = "center";
                notify_p = document.createElement('p');
                notify_p.textContent = "لا يوجد مبلغ محدد لعملية الزراعة بعد , هل تريد تحديد مبلغ ؟";
                ok_button = document.createElement('button');
                ok_button.textContent = "نعم";
                ok_button.className = "ok-button";
                notify_p.className = "notify_p";
                ok_button.onclick = () => {
                    showform('set-implant-price-form');
                };
                control_area.appendChild(notify_p);
                control_area.appendChild(ok_button);

            }
            else{
                if(patient.implant_total!=patient.implant_current){
                    control_area.style.justifyContent = "space-between";
                    const right_div = document.createElement('div');
                    right_div.className = 'right_control_div';

                    const formatNumber = n => n !== undefined && n !== null ? n.toLocaleString('en-US') : '0';

                    const total_amount = document.createElement('div');
                    total_amount.className = 'total-amount';
                    total_amount.innerText = ` المبلغ الكلي : ${formatNumber(patient.implant_total)}`;
                    right_div.appendChild(total_amount);

                    const current_amount = document.createElement('div');
                    current_amount.className = 'current-amount';
                    current_amount.innerText = `المبلغ الحالي : ${formatNumber(patient.implant_current)}`;
                    right_div.appendChild(current_amount);
                    
                    const remaining_amount = document.createElement('div');
                    remaining_amount.className = 'remaining-amount';
                    remaining_amount.innerText = `المبلغ المتبقي : ${formatNumber(patient.implant_total - patient.implant_current)}`;
                    right_div.appendChild(remaining_amount);

                    control_area.appendChild(right_div);

                    const left_div = document.createElement('div');
                    left_div.className = 'left_control_div';

                    const add_amount_button = document.createElement('button');
                    add_amount_button.textContent = "إضافة مبلغ";
                    add_amount_button.className = "add-amount-button";
                    add_amount_button.onclick = () => {
                        showform('add-implant-amount-form');
                    };
                    left_div.appendChild(add_amount_button);

                    control_area.appendChild(left_div);

                }
                else{
                    control_area.style.justifyContent = "space-between";
                    const right_div = document.createElement('div');
                    right_div.className = 'right_control_div';

                    const formatNumber = n => n !== undefined && n !== null ? n.toLocaleString('en-US') : '0';

                    const total_amount = document.createElement('div');
                    total_amount.className = 'total-amount';
                    total_amount.innerText = ` المبلغ الكلي : ${formatNumber(patient.implant_total)}`;
                    right_div.appendChild(total_amount);

                    const current_amount = document.createElement('div');
                    current_amount.className = 'current-amount';
                    current_amount.innerText = `المبلغ الحالي : ${formatNumber(patient.implant_current)}`;
                    right_div.appendChild(current_amount);
                    
                    const remaining_amount = document.createElement('div');
                    remaining_amount.className = 'remaining-amount';
                    remaining_amount.innerText = `المبلغ المتبقي : ${formatNumber(patient.implant_total - patient.implant_current)}`;
                    right_div.appendChild(remaining_amount);

                    control_area.appendChild(right_div);

                    const left_div = document.createElement('div');
                    left_div.className = 'left_control_div';

                    const done_div = document.createElement('div');
                    done_div.className = "done-div";
                    done_div.textContent = "مكتمل";
                    left_div.appendChild(done_div);

                    const reset = document.createElement('button');
                    reset.textContent = "حذف المبالغ المسجلة";
                    reset.className = "reset-button";
                    reset.onclick = () => {
                        document.getElementById('reset-warning-message').textContent = `هل انت متأكد من حذف جميع المبالغ المسجلة ؟`;
                        showResetWarning();
                    };
                    left_div.appendChild(reset);

                    control_area.appendChild(left_div);
                }
            }
        }

        function showBraces(){
            page_to_load = 3;
            renderTabs(3);
            const tabInfoArea = document.querySelector('.tab_info_area');
            tabInfoArea.innerHTML = "";
            patient.meetings.forEach(meeting => {
                if(meeting.meeting_type == "braces"){
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => {
                        window.pywebview.api.deleteMeeting(meeting.id).then(() => {
                            refresh_data();
                        });
                    };
                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<svg viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M3.5362 5.29854C3.861 5.23721 4.19511 5.34035 4.42884 5.57407L6.90007 8.0453C7.21718 8.36241 7.73131 8.36241 8.04842 8.0453C8.36553 7.7282 8.36553 7.21406 8.04842 6.89695L5.57841 4.42694C5.34457 4.1931 5.24146 3.85877 5.30297 3.53383C5.36449 3.2089 5.58266 2.93539 5.8858 2.8032C8.06696 1.85206 10.7034 2.26698 12.4903 4.05384C13.9041 5.46765 14.4588 7.41411 14.1581 9.24419L21.0366 16.1227C22.3936 17.4796 22.3936 19.6797 21.0366 21.0367C19.6796 22.3936 17.4796 22.3936 16.1226 21.0367L9.24405 14.1581C7.41401 14.4588 5.46762 13.904 4.05384 12.4903C2.26556 10.702 1.85139 8.06276 2.80548 5.88058C2.93789 5.57772 3.2114 5.35986 3.5362 5.29854ZM4.30644 8.2801C4.30858 9.29283 4.69632 10.3043 5.46805 11.076C6.50688 12.1149 7.97927 12.4581 9.30695 12.1009C9.6523 12.008 10.021 12.1066 10.2739 12.3595L17.5368 19.6225C18.1127 20.1984 19.0465 20.1984 19.6224 19.6225C20.1983 19.0466 20.1983 18.1128 19.6224 17.5369L12.3595 10.274C12.1066 10.0211 12.008 9.65241 12.1009 9.30705C12.4582 7.97934 12.1149 6.50691 11.076 5.46805C10.3059 4.69791 9.29699 4.31018 8.28635 4.30645L9.46264 5.48274C10.5608 6.58089 10.5608 8.36136 9.46264 9.45952C8.36448 10.5577 6.58401 10.5577 5.48586 9.45952L4.30644 8.2801Z" fill="#ffffff"></path> </g></svg>';
                    editButton.className = 'edit-button';
                    editButton.onclick = () => {
                        document.getElementById('info').value = meeting.info;
                        document.getElementById('date').value = meeting.date;
                        if (meeting.time==1){
                            switchToDay();
                        }
                        else{
                            switchToNight();
                        }
                        edit_id = meeting.id;
                        editing = true;
                        document.getElementById('form-name').innerText = "تعديل الجلسة";
                        showform('meeting-form');
                    };
                    let time_word = meeting.time == 1 ? "صباحاً" : "مساءً";
                    const meetingDiv = document.createElement('div');
                    meetingDiv.classList.add('meeting');
                    meetingDiv.innerHTML = `
                        <div class="meeting_info_area">
                            <p>${meeting.info}</p>
                            <p>${time_word}</p>
                            <p style="font-size: 0.85em;">${meeting.date.replace(/-/g, '/')}</p>
                        </div>
                        <div class="btns_area"></div>
                    `;
                    meetingDiv.querySelector('.btns_area').appendChild(editButton);
                    meetingDiv.querySelector('.btns_area').appendChild(deleteButton);
                    tabInfoArea.appendChild(meetingDiv);
                }
            });
            meeting_type = "braces";
            const addMeetingBtn = document.createElement('button');
            addMeetingBtn.className = 'add-button';
            addMeetingBtn.textContent = '+';
            addMeetingBtn.style.margin = '24px auto 0 auto';
            addMeetingBtn.style.display = 'block';
            addMeetingBtn.onclick = () => {
                document.getElementById('form-name').innerText = "اضافة جلسة";
                document.getElementById('meeting-form').reset();
                document.getElementById('info').value = '';
                document.getElementById('date').value = '';
                switchToNight();
                editing = false;
                edit_id = null;
                showform('meeting-form');
            };
            tabInfoArea.appendChild(addMeetingBtn);
            const control_area = document.getElementById('control_area');
            control_area.innerHTML = "";
            control_area.style.height = "12%";
        }

        window.addEventListener('pywebviewready', async function() {
            patient = await window.pywebview.api.load_patient();
            renderPatientCard();
            refreshDoctor();
        });

        async function refresh_data(){
            patient = await window.pywebview.api.load_patient();
            renderPatientCard();
        }

        function renderPatientCard() {
            const infoCard = document.querySelector('.info_card');
            if (patient) {
                infoCard.innerHTML = "";
                const rightDiv = document.createElement('div');
                rightDiv.classList.add('right_div');
                const baseInfo = document.createElement('div');
                baseInfo.classList.add('base_info');
                let doctor  = "";
                if (patient.doctor.includes("0")) {
                    
                    doctor += " د.احمد و";
                }
                if (patient.doctor.includes("1")) {
                    
                    doctor += " د.مصطفى و";
                }
                if (patient.doctor.includes("2")) {
                    
                    doctor += " د.ضياء و";
                }
                let doctor_str = doctor.slice(0, -2);
                
                baseInfo.innerHTML = `
                    <p class="name_p">${patient.name}</p>
                    <p>رقم الهاتف: ${patient.phone_num}</p>
                    <p>الطبيب المشرف : ${doctor_str}</p>
                    
                    
                `;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'buttons_div';

                patient_edit_button = document.createElement('button');
                patient_edit_button.className = 'patient-edit-button';
                patient_edit_button.textContent = 'تعديل معلومات المريض';

                patient_edit_button.onclick = () => {
                    // Open edit patient form
                    showform('edit-patient-form');

                    document.getElementById('name').value = patient.name;
                    document.getElementById('phone_num').value = patient.phone_num;

                    if(patient.treat_type!="none"){
                        document.getElementById('treat_type').value = patient.treat_type;
                        document.getElementById('treat_type_group').style.display = 'flex';
                    }
                    else {
                        document.getElementById('treat_type').value = '';
                        document.getElementById('treat_type_group').style.display = 'none';
                    }
                    if(patient.implant_total!=0){
                        document.getElementById('implant_total').value = patient.implant_total;
                        document.getElementById('implant_total_group').style.display = 'flex';
                        document.getElementById('implant_current_group').style.display = 'flex';
                        document.getElementById('implant_current').value = patient.implant_current;
                    }
                    else {
                        document.getElementById('implant_total').value = '';
                        document.getElementById('implant_total_group').style.display = 'none';
                        document.getElementById('implant_current_group').style.display = 'none';
                        document.getElementById('implant_current').value = '';
                    }
                    
                    
                };
                buttonsDiv.appendChild(patient_edit_button);

                patient_delete_button = document.createElement('button');
                patient_delete_button.className = 'patient-delete-button';
                patient_delete_button.textContent = 'حذف المريض';

                patient_delete_button.onclick = () => {
                    // Open delete patient confirmation
                    showDeleteWarning();
                };
                buttonsDiv.appendChild(patient_delete_button);

                baseInfo.appendChild(buttonsDiv);
                rightDiv.appendChild(baseInfo);

                const leftDiv = document.createElement('div');
                leftDiv.classList.add('left_div');
                const tabsArea = document.createElement('div');
                tabsArea.classList.add('tabs_area');
                leftDiv.appendChild(tabsArea);
                const tabInfoArea = document.createElement('div');
                tabInfoArea.classList.add('tab_info_area');
                const control_area = document.createElement('div');
                control_area.classList.add('control_area');
                control_area.id = 'control_area';
                leftDiv.appendChild(tabInfoArea);
                leftDiv.appendChild(control_area);
                infoCard.appendChild(rightDiv);
                infoCard.appendChild(leftDiv);

                // Render tabs and show correct tab
                let tabIdx = 0;
                if(page_to_load==-1){
                    page_to_load = patient.page_to_load;
                }
                tabIdx = page_to_load;
                renderTabs(tabIdx);
                if(tabIdx == 0){
                    showMeetings();
                }
                else if(tabIdx == 1){
                    showSendnReceive();
                }
                else if(tabIdx == 2){
                    showImplant();
                }
                else if(tabIdx == 3){
                    showBraces();
                }
            } else {
                infoCard.innerHTML = `<p>لا يوجد بيانات لهذا المريض</p>`;
            }
        }
        
        function flashOnce(id,time=1) {
            // make it flex instantly
            const el = document.getElementById(id);
            el.style.display = "flex";
            el.style.opacity = "1";

            // force reflow to apply instant show
            void el.offsetWidth;

            // re-enable fade
            el.style.transition = "opacity 0.6s ease-in-out";

            // after 1s, start fade out
            setTimeout(() => {
                el.style.opacity = "0";

                // when fade ends, hide fully
                el.addEventListener("transitionend", function handler() {
                if (el.style.opacity === "0") {
                    el.style.display = "none";
                }
                el.removeEventListener("transitionend", handler);
                });
            }, time*1000);
        }

        function showform(form_id,instant = false){
            if(form_id=="transfer-form"){
                document.getElementById('transfer_type').value = '1';
            }
            form = document.getElementById(form_id);
            form.hidden = false;
            form.style.opacity = 1;
        }
        
        function closeform(form_id,success = true){
            const form = document.getElementById(form_id);
            form.reset();
            form.hidden  = true;
            if(success){
                const card = document.getElementById("success_card");
                if(form_id=="meeting-form"){
                    card.innerText = " ! تم اضافة الجلسة بنجاح "; // <-- changed text here
                }
                else{
                    card.innerText = " ! تمت تعديل معلومات المريض بنجاح ";
                }
                flashOnce("success_card");    
            }
        }

        async function submitform(type = "general") {
            const form = document.getElementById('meeting-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            let date = document.getElementById("date").value.trim();
            if (!editing) {
                if(date == ""){
                    showError("يرجى ادخال التاريخ");
                }
                else{
                    await window.pywebview.api.createMeeting(data, time, patient.id, type);
                    await refresh_data();
                    closeform('meeting-form');
                }
                
            } else {
                if(date == ""){
                    showError("يرجى ادخال التاريخ");
                }
                else{
                    await window.pywebview.api.editMeeting(edit_id, data, time, patient.id);
                    await refresh_data();
                    closeform('meeting-form');
                }
                
            }
        }

        function submitTransferForm() {
            const form = document.getElementById('transfer-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            let clinic_name = document.getElementById("clinic_name").value.trim();
            let date = document.getElementById("t_date").value.trim();
            if (!editing) {
                if(clinic_name == ""){
                    showError("يرجى ادخال اسم العيادة");
                }
                else if(date == ""){
                    showError("يرجى ادخال التاريخ");
                }
                else{
                    window.pywebview.api.createTransfer(
                        data.transfer_type,
                        data,
                        patient.id
                    ).then(() => {
                        refresh_data();
                        closeform('transfer-form');
                    });
                }
                
            } else {
                if(clinic_name == ""){
                    showError("يرجى ادخال اسم العيادة");
                }
                else if(date == ""){
                    showError("يرجى ادخال التاريخ");
                }
                else{
                    window.pywebview.api.editTransfer(
                    data.transfer_type,
                    edit_id,
                    data,
                ).then(() => {
                    refresh_data();
                    closeform('transfer-form');
                });
                }
                
            }
        }

        function switchToDay(){
            time = 1;
            document.getElementById("day_button").classList.add('active');
            document.getElementById("night_button").classList.remove('active');            
        }
        function switchToNight(){
            time = 0;
            document.getElementById("day_button").classList.remove('active');
            document.getElementById("night_button").classList.add('active');          
        }

        async function submitSetImplantPriceForm(){
            // get the amount from the input filed and pass it to a pywebview func called setImplantAmount
            const form = document.getElementById('set-implant-price-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            let implant_total = document.getElementById("implant_total_2").value.trim();

            if(implant_total==""){
                showError("يرجى ادخال مبلغ الزراعة");
            }
            else{
                await window.pywebview.api.setImplantAmount(data.implant_total, patient.id);
                await refresh_data();
                closeform('set-implant-price-form');
            }
            
        }

        async function submitSetTreatmentTypeForm(){
            // get the amount from the input filed and pass it to a pywebview func called setImplantAmount
            const form = document.getElementById('set-treatment-type-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            await window.pywebview.api.setTreatmentType(data.treat_type, patient.id);
            await refresh_data();
            closeform('set-treatment-type-form');
        }
        
        
        async function addAmount(){
            // get the amount from the input filed and pass it to a pywebview func called setImplantAmount
            const form = document.getElementById('add-implant-amount-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            let amount = document.getElementById("amount").value.trim();
            if(amount==""){
                showError("يرجى ادخال مبلغ");
            }
            else{
                
                await window.pywebview.api.addAmount(data.amount, patient.id);
                await refresh_data();
                closeform('add-implant-amount-form');
            }
        }

        function showResetWarning() {
            const warningCard = document.getElementById('reset-warning');
            warningCard.style.display = 'flex';
        }
        function hideResetWarning() {
            const warningCard = document.getElementById('reset-warning');
            warningCard.style.display = 'none';
        }
        function showTreatmentWarning() {
            const warningCard = document.getElementById('treatment-warning');
            warningCard.style.display = 'flex';
        }
        function hideTreatmentWarning() {
            const warningCard = document.getElementById('treatment-warning');
            warningCard.style.display = 'none';
        }
        function showDeleteWarning() {
            const warningCard = document.getElementById('delete-patient-form');
            warningCard.style.display = 'flex';
        }
        function hideDeleteWarning() {
            const warningCard = document.getElementById('delete-patient-form');
            warningCard.style.display = 'none';
        }
        function resetAmounts(){
            window.pywebview.api.resetAmounts(patient.id).then(() => {
                refresh_data();
                hideResetWarning();
            });
        }
        function doneifyPatient(){
            window.pywebview.api.doneifyPatient(patient.id).then(() => {
                refresh_data();
            });
        }
        function resetTreatment(){
            window.pywebview.api.resetTreatment(patient.id).then(() => {
                refresh_data();
                hideTreatmentWarning();
            });
        }

        function submitEditPatientForm(){
            const form = document.getElementById('edit-patient-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            let name = document.getElementById("name").value.trim();
            let phone_num= document.getElementById("phone_num").value.trim();
            if(name == "" || (name.split(" ").length - 1) < 2){
                showError("يرجى ادخال الاسم الثلاثي");
            }
            else if(phone_num == ""){
                showError("يرجى ادخال رقم الهاتف");
            }
            else if(phone_num.length != 11){
                showError("يرجى ادخال رقم الهاتف بشكل صحيح");
            }
            else{
                window.pywebview.api.editPatient(data, patient.id).then(() => {
                refresh_data();
                closeform('edit-patient-form');
            });
            }
            
        }
        function deletePatient(){
            window.pywebview.api.deletePatient(patient.id).then(() => {
                hideDeleteWarning();
                changeView('index');
            });
        }
        function showDoctorsList(){
            const list = document.getElementById('doctors_list');
            list.style.width = "40vw";
            list.style.opacity = "1";
        }
        function hideDoctorsList(){
            const list = document.getElementById('doctors_list');
            list.style.width = "0%";
            list.style.opacity = "0";
        }

        function refreshDoctor(){
            
            const data = {
                "-1": { name: "الكل",     img: "user-1.png" },
                "0":    { name: "د.أحمد",   img: "user0.png" },
                "1":    { name: "د.مصطفى", img: "user1.png" },
                "2":    { name: "د.ضياء",   img: "user2.png" }
            };

            const d = data[doctor];
            const img = document.getElementById("selected_doctor_img");
            const p = document.getElementById("selected_doctor_p");
            const list = document.getElementById("doctors_list");

            if (!d) { p.textContent = doctor; return; }

            img.src = d.img;
            p.textContent = d.name;

            list.innerHTML = "";
            Object.keys(data).forEach(id => {
                if (Number(id) === Number(doctor)) return;
                const doctor_btn_group = document.createElement("div");
                doctor_btn_group.className = "doctor_btn_group";
                const btn = document.createElement("button");
                btn.className = "doctor_button";
                const i = document.createElement("img");
                i.src = data[id].img;
                const tp = document.createElement("p");
                tp.className = "doctor_name";
                tp.textContent = data[id].name;
                btn.appendChild(i);
                doctor_btn_group.appendChild(btn);
                doctor_btn_group.appendChild(tp);
                btn.onclick = () => selectDoctor(id);
                list.appendChild(doctor_btn_group);
            });
        }

        async function selectDoctor(id){
        await window.pywebview.api.changeCurrentDoctor(id);
        doctor = String(id);
        await refreshMeetings(new Date(year, month - 1, day));
        refreshDoctor();
        hideDoctorsList();
    }
    function showError(msg,time=1.5){
        const card = document.getElementById("missing_data");
        card.innerText = msg;
        flashOnce("missing_data",time);
    }
    </script>
</body>
</html>